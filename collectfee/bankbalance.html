<!DOCTYPE html>
<!--[if IE 8]>
<html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!-->
<html lang="zh">
<!--<![endif]-->

<!-- BEGIN HEAD -->

<head>
    <title>银行对账查询</title>
    <script src="../pages/scripts/basepath.js"></script>
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-select/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/select2/select2.css">
    <script src="../pages/scripts/header.js"></script>
    <meta http-equiv="content-type" content="text/html" charset="utf-8" />
    <link href='../assets/global/plugins/jquery-watable/watable.css' rel='stylesheet' />
    <link href='../assets/global/plugins/jquery-watable/animate.min.css' rel='stylesheet' />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.css"
    />
    <link href='../assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css' rel='stylesheet' />

    <!--datapicker css start-->
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-datepicker/css/datepicker3.css" />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css"
    />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-colorpicker/css/colorpicker.css" />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-daterangepicker/daterangepicker-bs3.css"
    />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css" />
    <!--datapicker end-->
</head>
<!-- END HEAD -->

<body class="page-header-fixed page-quick-sidebar-over-content">

    <!-- 标题栏开始 -->
    <div class="page-header navbar navbar-fixed-top">
        <script>
            $.include("pages/partial/menu.shtml");
        </script>
    </div>
    <!-- 标题栏结束 -->
    <div class="clearfix"></div>
    <div class="page-container">
        <!-- 左侧菜单开始 -->
        <div class="page-sidebar-wrapper">
            <script>
                $.include("pages/partial/sidebar.shtml");
            </script>
        </div>
        <!-- 左侧菜单结束 -->
        <!-- 主内容开始 -->
        <div class="page-content-wrapper">
            <div class="page-content">
                <!--内容头开始-->
                <script>$.include("common/navigation_bar.shtml");</script>
                <!-- 内容头结束-->

                <!-- 内容开始-->



                <div id="divSearchContainer" class="tabbable tabbable-custom tabbable-custom-profile col-md-12" style="padding-bottom:0px;">
                    <ul class="nav nav-tabs">
                        <li role="presentation" class="active">
                            <a href="#search" aria-controls="search" role="tab" data-toggle="tab">查询</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane  active" id="search">
                            <div data-always-visible="1" data-rail-visible="1">
                                <div class="row">
                                    <div class="col-sm-5 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">开始日期:</div>
                                            <div class="input-group input-large date-picker input-daterange" data-date-format="yyyy-mm-dd">
                                                <input id="find_start_date" type="text" class="form-control">
                                                <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                                <span class="input-group-addon">至</span>
                                                <input id="find_end_date" type="text" class="form-control">
                                                <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-3 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">银行:</div>
                                            <select id="find_bank" class="form-control input-small select2me" data-placeholder="请选择银行">
                                                <option value="">全部</option>
                                            </select>
                                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <button id="find_bankbalance" type="button" class="btn yellow">
                                                查询
                                                <i class="fa fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="divSearchContainer" class="tabbable tabbable-custom tabbable-custom-profile col-md-12" style="padding-bottom:0px;">
                    <ul class="nav nav-tabs">
                        <li role="presentation" class="active">
                            <a href="#balanceMgmt" aria-controls="balanceMgmt" role="tab" data-toggle="tab">银行对账</a>
                        </li>
                        <li role="presentation">
                            <a href="#bankDate" aria-controls="bankDate" role="tab" data-toggle="tab">按银行对账日期查询</a>
                        </li>
                        <li role="presentation">
                            <a href="#tradeDate" aria-controls="tradeDate" role="tab" data-toggle="tab">按系统交易日期查询</a>
                        </li>

                    </ul>
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane  active" id="balanceMgmt">
                            <div data-always-visible="1" data-rail-visible="1">
                                <div class="container-fluid">
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费总计:</div>
                                            <input id="gastotal" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费手续费总计:</div>
                                            <input id="gasrate" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费笔数总计:</div>
                                            <input id="gascount" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">垃圾费总计:</div>
                                            <input id="wastetotal" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">垃圾费手续费总计:</div>
                                            <input id="wasterate" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">垃圾费笔数总计:</div>
                                            <input id="wastecount" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费、垃圾费合计:</div>
                                            <input id="gaswastesum" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">手续费合计:</div>
                                            <input id="gaswasteratesum" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div id="divtable" class="table-responsive container-fluid col-md-12">
                                    </div>
                                </div>
                                <div class="container-fluid">
                                    <div id="divBalanceContainer" class="tabbable tabbable-custom tabbable-custom-profile col-md-12" style="padding-bottom:0px; display: none">
                                        <ul class="nav nav-tabs">
                                            <li role="presentation" class="active">
                                                <a href="#gasFee" aria-controls="gasFee" role="tab" data-toggle="tab">燃气费</a>
                                            </li>
                                            <li role="presentation">
                                                <a href="#wasteFee" aria-controls="wasteFee" role="tab" data-toggle="tab">垃圾处理费</a>
                                            </li>
                                        </ul>
                                        <div class="tab-content">
                                            <div role="tabpanel" class="tab-pane" id="wasteFee">
                                                <div data-always-visible="1" data-rail-visible="1">
                                                    <div id="divwastedetailtable" class="table-responsive container-fluid col-md-12">
                                                    </div>
                                                </div>
                                            </div>
                                            <div role="tabpanel" class="tab-pane active" id="gasFee">
                                                <div data-always-visible="1" data-rail-visible="1">
                                                    <div id="divgasdetailtable" class="table-responsive container-fluid col-md-12">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="tradeDate">
                            <div data-always-visible="1" data-rail-visible="1">
                                <div class="container-fluid">
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费总计:</div>
                                            <input id="tradegastotal" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费手续费总计:</div>
                                            <input id="tradegasrate" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费笔数总计:</div>
                                            <input id="tradegascount" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">垃圾费总计:</div>
                                            <input id="tradewastetotal" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">垃圾费手续费总计:</div>
                                            <input id="tradewasterate" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">垃圾费笔数总计:</div>
                                            <input id="tradewastecount" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费、垃圾费合计:</div>
                                            <input id="tradegaswastesum" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">手续费合计:</div>
                                            <input id="tradegaswasteratesum" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div id="tradedivtable" class="table-responsive container-fluid col-md-12">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="bankDate">
                            <div data-always-visible="1" data-rail-visible="1">
                                <div class="container-fluid">
                                    <!-- <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费总计:</div>
                                            <input id="fingastotal" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费手续费总计:</div>
                                            <input id="fingasrate" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费笔数总计:</div>
                                            <input id="fingascount" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">垃圾费总计:</div>
                                            <input id="finwastetotal" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">垃圾费手续费总计:</div>
                                            <input id="finwasterate" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">垃圾费笔数总计:</div>
                                            <input id="finwastecount" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">燃气费、垃圾费合计:</div>
                                            <input id="fingaswastesum" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 form-group">
                                        <div class="btn-group input-group pull-left">
                                            <div class="input-group-addon">手续费合计:</div>
                                            <input id="fingaswasteratesum" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon hide"></span>
                                        </div>
                                    </div> -->
                                    <div id="findivtable" class="table-responsive container-fluid col-md-12">
                                    </div>
                                </div>
                            </div>
                            <!-- <table class="watable table table-striped table-hover table-bordered table-condensed">
                                <thead>
                                    <tr class="sort">
                                        <th>
                                            <span class="pull-left">对账结果</span>
                                        </th>
                                        <th>
                                            <span class="pull-left">银行</span>
                                        </th>
                                        <th>
                                            <span class="pull-left">对账日期</span>
                                        </th>
                                        <th>
                                            <span class="pull-left">燃气费金额</span>
                                        </th>
                                        <th>
                                            <span class="pull-left">垃圾费金额</span>
                                        </th>
                                        <th>
                                            <span class="pull-left">是否跨月</span>
                                        </th>
                                        <th>
                                            <span class="pull-left">是否冲销</span>
                                        </th>
                                    </tr>
                                </thead>
                            </table> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 主内容结束 -->
    </div>
    <div class="modal fade bs-example-modal-lg" id="queryBalanceModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">对账处理</h4>
                </div>
                <div id="mcontent" class="modal-body">
                    <div data-always-visible="1" data-rail-visible="1">
                        <table class="watable table table-striped table-hover table-bordered table-condensed">
                            <thead>
                                <tr>
                                    <th>
                                        银行名称
                                    </th>
                                    <th>
                                        交易类型
                                    </th>
                                    <th>
                                        交易流水号
                                    </th>
                                    <th>
                                        交易日期
                                    </th>
                                    <th>
                                        客户编号
                                    </th>
                                    <th>
                                        交易金额
                                    </th>
                                    <th>
                                        对账操作
                                    </th>
                                    <th>

                                    </th>
                                </tr>
                            </thead>
                            <tbody id="_queryBalanceItems">
                            </tbody>
                        </table>
                    </div>

                    <button class="btn btn-success btn-sm" onclick="doReBalance()"> 重新内部对账</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
                $.include("pages/partial/xwatable-form.shtml")
    </script>
    <!-- 底边栏开始 -->
    <script>
                $.include("pages/partial/foot.shtml");
    </script>
    <!--英尺-->
    <!-- 底边栏结束 -->
    <div class="modal fade" id="hzqModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog">
            <div id="mcontent" class="modal-content">
            </div>
        </div>
    </div>
</body>


<script>
                $.include("pages/partial/scripts.shtml");

</script>
<!--跳到原稿-->
<script src="../assets/global/plugins/jquery.cokie.min.js" type="text/javascript"></script>
<script type="text/javascript" src="../assets/global/plugins/jquery-watable/jquery.watable.js"></script>
<script type="text/javascript" src="../pages/scripts/rqlbuilder.js"></script>
<script type="text/javascript" src="../pages/scripts/xwatable.js"></script>
<script type="text/javascript" src="../pages/scripts/refhelper.js"></script>

<!--datapicker start-->
<script type="text/javascript" src="../assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/clockface/js/clockface.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/moment.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<script src="../assets/admin/pages/scripts/components-pickers.js"></script>


<script src="../collectfee/js/reporttable.js"></script>
<script src="../collectfee/js/errorApply.js"></script>
<!--datapicker end-->

<script type="text/javascript">
                var userInfo = JSON.parse(localStorage.getItem('user_info'));
                var clearDate = "";

                var balanceResultFormat = function () {
                    return {
                        f: function (data, row) {
                            console.log(data);
                            if (data != '' && data != undefined) {
                                if (data == "2") {
                                    return "<button class=\"btn btn-danger btn-sm\" onclick=\"queryBalanceInfo('" + row.bankCode + "','" + row.bankName + "','" + row.tradeDate + "')\">对账不通过</button>";
                                }
                                if (data == "3") {
                                    return "<span class=\"label label-success btn-sm\">对账通过</span>";
                                }
                                if (data == "4") {
                                    return "<span class=\"label label-warning btn-sm\">需银行重新发起对账</span>";
                                }
                                return "<span class=\"label label-primary btn-sm\">未对账</span>";
                            } else {
                                if (row.bankGasTotal == row.recordGasTotal
                                    && row.bankGasCount == row.recordGasCount
                                    && row.bankWasteTotal == row.recordWasteTotal
                                    && row.bankWasteCount == row.recordWasteCount) {
                                    return "<span class=\"label label-success btn-sm\">对账通过</span>";
                                } else if (row.bankGasTotal == undefined && row.bankGasCount == undefined && row.bankWasteTotal == undefined && row.bankWasteCount == undefined) {
                                    return "<span class=\"label label-primary btn-sm\">未对账</span>";
                                } else {
                                    return "<button class=\"btn btn-danger btn-sm\" onclick=\"queryBalanceInfo('" + row.bankCode + "','" + row.bankName + "','" + row.tradeDate + "')\">对账不通过</button>";
                                }
                            }
                        }
                    }
                }();
                var queryBalanceInfo = function (bankCode, bankName, balanceDate) {
                    $.ajax({
                        url: "http://172.16.40.31/hzqsbankface/bkf/pbqbc.do?fh=QBCBKF0000000J00&resp=bd",
                        dataType: "json",
                        data: JSON.stringify({
                            "clearDate": balanceDate,
                            "bankCode": bankCode
                        }),
                        contentType: "application/json;charset=utf-8",
                        type: "POST",
                        success: function (data) {
                            var diff = data.diff;
                            if (diff.indexOf("<") != -1 || diff.indexOf(">") != -1) {
                                var diffItems = diff.split("||");
                                $("#queryBalanceModal").find("#_queryBalanceItems").html("");
                                $("#queryBalanceModal").modal('show');
                                diffItems.forEach(function (element) {
                                    var rowData = element.split('&&')[0];
                                    var feeType = element.split('&&')[1];
                                    if (rowData.indexOf("<") == rowData.length - 1) {
                                        // 02 20170811084253 142205038 280.00 20170811
                                        var bankCode = rowData.split(" ")[0];
                                        var serialNo = rowData.split(" ")[1];
                                        var customerCode = rowData.split(" ")[2];
                                        var fee = rowData.split(" ")[3];
                                        var bankDate = rowData.split(" ")[4];
                                        bankDate = bankDate.substring(0, bankDate.length - 1);
                                        if (feeType == "gas") {
                                            $.ajax({
                                                url: "hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd",
                                                type: "POST",
                                                async: false,
                                                contentType: "application/json;charset=utf-8",
                                                data: JSON.stringify({
                                                    cols: "customerType",
                                                    froms: "gasCtmArchive",
                                                    wheres: "customerCode='" + customerCode + "'",
                                                    page: "false",
                                                    limit: 1
                                                }),
                                                dataType: "json",
                                                success: function (data) {
                                                    if (data && data.rows && data.rows.length > 0) {
                                                        if (data.rows[0].customerType == "P") {
                                                            $("#queryBalanceModal").find("#_queryBalanceItems").append("<tr><td>" + bankName + "</td><td>燃气缴费(1002)</td><td>" + serialNo + "</td><td>" + bankDate + "</td><td>" + customerCode + "</td><td>" + fee + "</td><td>补充交易</td><td><button class=\"btn btn-danger btn-xs\" onclick=\"doChgGasBiz('" + customerCode + "','" + bankCode + "','" + fee + "','" + serialNo + "','" + bankDate + "',this)\">处理</button></td></tr>");
                                                        } else {
                                                            $("#queryBalanceModal").find("#_queryBalanceItems").append("<tr><td>" + bankName + "</td><td>IC卡缴费(1025)</td><td>" + serialNo + "</td><td>" + bankDate + "</td><td>" + customerCode + "</td><td>" + fee + "</td><td>补充交易</td><td><button class=\"btn btn-danger btn-xs\" onclick=\"doChgIcGasBiz('" + customerCode + "','" + bankCode + "','" + fee + "','" + serialNo + "','" + bankDate + "',this)\">处理</button></td></tr>");
                                                        }
                                                    }
                                                },
                                                error: function () {
                                                }
                                            });

                                        } else if (feeType == "waste") {
                                            $("#queryBalanceModal").find("#_queryBalanceItems").append("<tr><td>" + bankName + "</td><td>垃圾费缴费(1102)</td><td>" + serialNo + "</td><td>" + bankDate + "</td><td>" + customerCode + "</td><td>" + fee + "</td><td>补充交易</td><td><button class=\"btn btn-danger btn-xs\" onclick=\"doChgWasteBiz('" + customerCode + "','" + bankCode + "','" + fee + "','" + serialNo + "','" + bankDate + "',this)\">处理</button></td></tr>");
                                        }
                                    } else if (rowData.indexOf(">") == rowData.length - 1) {
                                        // 02 20170811161054 140004047 56.00 20170811
                                        var bankCode = rowData.split(" ")[0];
                                        var serialNo = rowData.split(" ")[1];
                                        var customerCode = rowData.split(" ")[2];
                                        var fee = rowData.split(" ")[3];
                                        var bankDate = rowData.split(" ")[4];
                                        bankDate = bankDate.substring(0, bankDate.length - 1);
                                        if (feeType == "gas") {
                                            $.ajax({
                                                url: "hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd",
                                                type: "POST",
                                                async: false,
                                                contentType: "application/json;charset=utf-8",
                                                data: JSON.stringify({
                                                    cols: "customerType",
                                                    froms: "gasCtmArchive",
                                                    wheres: "customerCode='" + customerCode + "'",
                                                    page: "false",
                                                    limit: 1
                                                }),
                                                dataType: "json",
                                                success: function (data) {
                                                    if (data && data.rows && data.rows.length > 0) {
                                                        if (data.rows[0].customerType == "P") {
                                                            $("#queryBalanceModal").find("#_queryBalanceItems").append("<tr><td>" + bankName + "</td><td>燃气冲正(1009)</td><td>" + serialNo + "</td><td>" + bankDate + "</td><td>" + customerCode + "</td><td>" + fee + "</td><td>冲销交易</td><td><button class=\"btn btn-danger btn-xs\" onclick=\"doCorGasBiz('" + customerCode + "','" + bankCode + "','" + fee + "','" + serialNo + "','" + bankDate + "',this)\">处理</button></td></tr>");
                                                        } else {
                                                            $("#queryBalanceModal").find("#_queryBalanceItems").append("<tr><td>" + bankName + "</td><td>IC卡冲正(1009)</td><td>" + serialNo + "</td><td>" + bankDate + "</td><td>" + customerCode + "</td><td>" + fee + "</td><td>冲销交易</td><td><button class=\"btn btn-danger btn-xs\" onclick=\"doCorIcGasBiz('" + customerCode + "','" + bankCode + "','" + fee + "','" + serialNo + "','" + bankDate + "',this)\">处理</button></td></tr>");
                                                        }
                                                    }
                                                },
                                                error: function () {
                                                }
                                            });
                                        } else if (feeType == "waste") {
                                            $("#queryBalanceModal").find("#_queryBalanceItems").append("<tr><td>" + bankName + "</td><td>垃圾费冲正(1109)</td><td>" + serialNo + "</td><td>" + bankDate + "</td><td>" + customerCode + "</td><td>" + fee + "</td><td>冲销交易</td><td><button class=\"btn btn-danger btn-xs\" onclick=\"doCorWasteBiz('" + customerCode + "','" + bankCode + "','" + fee + "','" + serialNo + "','" + bankDate + "',this)\">处理</button></td></tr>");
                                        }
                                    }
                                });
                            }
                        }, error: function (data) {
                            bootbox.alert("查询失败");
                            //$("#BtnSub").removeAttr("disabled");
                        }
                    });
                };

                function doChgGasBiz(customerCode, bankCode, fee, serialNumber, tradeDate, obj) {
                    $.ajax({
                        url: "http://172.16.40.31/hzqsbankface/bkf/pbcbg.do?fh=CBGBKF0000000J00&resp=bd",
                        dataType: "json",
                        data: JSON.stringify({
                            "customerCode": customerCode,
                            "bankCode": bankCode,
                            "backUnit": "对账",
                            "optCode": "对账",
                            "fee": fee,
                            "serialNumber": serialNumber,
                            "tradeDate": tradeDate,
                            "bizCode": "1002"
                        }),
                        contentType: "application/json;charset=utf-8",
                        type: "POST",
                        success: function (data) {
                            if (data.errCode == "00") {
                                bootbox.alert("成功");
                                $(obj).closest("tr").empty();
                            } else {
                                bootbox.alert(JSON.stringify(data));
                            }
                        }
                    });
                }
                function doChgIcGasBiz(customerCode, bankCode, fee, serialNumber, tradeDate, obj) {
                    $.ajax({
                        url: "http://172.16.40.31/hzqsbankface/bkf/pbawb.do?fh=AWBBKF0000000J00&resp=bd",
                        dataType: "json",
                        data: JSON.stringify({
                            "customerCode": customerCode,
                            "bankCode": bankCode,
                            "optCode": "对账",
                            "fee": fee,
                            "serialNumber": serialNumber,
                            "tradeDate": tradeDate,
                            "bizCode": "1025"
                        }),
                        contentType: "application/json;charset=utf-8",
                        type: "POST",
                        success: function (data) {
                            if (data.errCode == "00") {
                                bootbox.alert("成功");
                                $(obj).closest("tr").empty();
                            } else {
                                bootbox.alert(JSON.stringify(data));
                            }
                        }
                    });
                }
                function doChgWasteBiz(customerCode, bankCode, fee, serialNumber, tradeDate, obj) {
                    $.ajax({
                        url: "http://172.16.40.31/hzqsbankface/bkf/pbcwf.do?fh=CWFBKF0000000J00&resp=bd",
                        dataType: "json",
                        data: JSON.stringify({
                            "customerCode": customerCode,
                            "bankCode": bankCode,
                            "backUnit": "对账",
                            "optCode": "对账",
                            "fee": fee,
                            "serialNumber": serialNumber,
                            "tradeDate": tradeDate,
                            "bizCode": "1102"
                        }),
                        contentType: "application/json;charset=utf-8",
                        type: "POST",
                        success: function (data) {
                            if (data.errCode == "00") {
                                bootbox.alert("成功");
                                $(obj).closest("tr").empty();
                            } else {
                                bootbox.alert(JSON.stringify(data));
                            }
                        }
                    });
                }
                function doCorGasBiz(customerCode, bankCode, fee, serialNumber, tradeDate, obj) {
                    $.ajax({
                        url: "http://172.16.40.31/hzqsbankface/bkf/pbgcr.do?fh=GCRBKF0000000J00&resp=bd",
                        dataType: "json",
                        data: JSON.stringify({
                            "customerCode": customerCode,
                            "bankCode": bankCode,
                            "backUnit": "对账",
                            "optCode": "对账",
                            "fee": fee,
                            "serialNumber": serialNumber,
                            "cancelDate": tradeDate,
                            "bizCode": "1009"
                        }),
                        contentType: "application/json;charset=utf-8",
                        type: "POST",
                        success: function (data) {
                            if (data.errCode == "00") {
                                bootbox.alert("成功");
                                $(obj).closest("tr").empty();
                            } else {
                                bootbox.alert(JSON.stringify(data));
                            }
                        }
                    });
                }
                function doCorIcGasBiz(customerCode, bankCode, fee, serialNumber, tradeDate, obj) {
                    $.ajax({
                        url: "http://172.16.40.31/hzqsbankface/bkf/pbcor.do?fh=CORBKF0000000J00&resp=bd",
                        dataType: "json",
                        data: JSON.stringify({
                            "customerCode": customerCode,
                            "bankCode": bankCode,
                            "optCode": "对账",
                            "bankUnit": "对账",
                            "fee": fee,
                            "serialNumber": serialNumber,
                            "cancelDate": tradeDate,
                            "bizCode": "1028"
                        }),
                        contentType: "application/json;charset=utf-8",
                        type: "POST",
                        success: function (data) {
                            if (data.errCode == "00") {
                                bootbox.alert("成功");
                                $(obj).closest("tr").empty();
                            } else {
                                bootbox.alert(JSON.stringify(data));
                            }
                        }
                    });
                }
                function doCorWasteBiz(customerCode, bankCode, fee, serialNumber, tradeDate, obj) {
                    $.ajax({
                        url: "http://172.16.40.31/hzqsbankface/bkf/pbcwc.do?fh=CWCBKF0000000J00&resp=bd",
                        dataType: "json",
                        data: JSON.stringify({
                            "customerCode": customerCode,
                            "bankCode": bankCode,
                            "backUnit": "对账",
                            "optCode": "对账",
                            "fee": fee,
                            "serialNumber": serialNumber,
                            "cancelDate": tradeDate,
                            "bizCode": "1109"
                        }),
                        contentType: "application/json;charset=utf-8",
                        type: "POST",
                        success: function (data) {
                            if (data.errCode == "00") {
                                bootbox.alert("成功");
                                $(obj).closest("tr").empty();
                            } else {
                                bootbox.alert(JSON.stringify(data));
                            }
                        }
                    });
                }
                function doReBalance() {
                    $.ajax({
                        url: "http://172.16.40.31/hzqsbankface/bkf/pbgbc.do?fh=GBCBKF0000000J00&resp=bd",
                        dataType: "json",
                        data: JSON.stringify({
                            "clearDate": clearDate
                        }),
                        contentType: "application/json;charset=utf-8",
                        type: "POST",
                        success: function (data) {
                            //if (data.errCode == "00") {
                            bootbox.alert("成功");
                            // } else {
                            //     bootbox.alert(JSON.stringify(data));
                            // }
                        }
                    });
                }

                var moneyFormat = function () {
                    return {
                        f: function (data, row) {
                            if (isNaN(parseFloat(data))) {
                                return "";
                            } else {
                                return "¥" + parseFloat(data).toFixed(2);
                            }
                        }
                    }
                }();
                var balanceStatusFormat = function () {
                    return {
                        f: function (data, row) {
                            if (data == "2") {
                                return "<span class=\"label label-danger\">未对账不通过</span>";
                            } else if (data == "3") {
                                return "<span class=\"label label-success\">对账通过</span>";
                            } else if (data == "4") {
                                return "<span class=\"label label-success\">补充对账通过</span>";
                            } else {
                                return "<span class=\"label label-danger\">未对账</span>";
                            }
                        }
                    }
                }();

                var isMonthFormat = function () {
                    return {
                        f: function (data, row) {
                            // 银行日期所属年，月，日
                            // 交易日期所属年，月，日
                            var bankYear = row.bankDate.substring(0, 4);
                            var bankMonth = row.bankDate.substring(4, 6);
                            var bankDay = row.bankDate.substring(6, 8);

                            var tradeYear = row.tradeDate.substring(0, 4);
                            var tradeMonth = row.tradeDate.substring(4, 6);
                            var tradeDay = row.tradeDate.substring(6, 8);

                            console.log("bankMonth:" + bankMonth + "   tradeMonth:" + tradeMonth);
                            if (bankMonth != tradeMonth) {
                                return "<span class=\"label label-danger\">跨月</span>";
                            } else {
                                return "-";
                            }
                        }
                    }
                }();
                var categoryFormat = function () {
                    return {
                        f: function (data, row) {
                            var bankDate = moment(row.bankDate, "YYYYMMDD");
                            var bankYear = row.bankDate.substring(0, 4);
                            var bankMonth = row.bankDate.substring(3, 2);
                            var bankDay = row.bankDate.substring(5, 2);

                            var tradeDate = moment(row.tradeDate, "YYYYMMDD");
                            var tradeYear = row.tradeDate.substring(0, 4);
                            var tradeMonth = row.tradeDate.substring(3, 2);
                            var tradeDay = row.tradeDate.substring(5, 2);

                            var tags = "";
                            if (bankDate.isBefore(tradeDate)) {
                                return "<span class=\"label label-danger\">冲销</span>";
                            }
                            if (row.bankDate == row.tradeDate) {
                                return "<span class=\"label label-success\">当天</span>";
                            }
                            if (bankDate.isAfter(tradeDate)) {
                                return "<span class=\"label label-info\">隔天</span>";
                            }
                            return "-";
                        }
                    }
                }();
                var bankCodeFormate = function () {
                    return {
                        f: function (bankCode, row) {
                            if (bankCode == '90') {
                                return "中国银行缴费";
                            } else if (bankCode == '1090') {
                                return "中国银行"
                            } else if (bankCode == '18') {
                                return "龙江银行"
                            } else if (bankCode == '92') {
                                return "邮政储蓄-IC"
                            } else if (bankCode == '10') {
                                return "光大银行"
                            } else if (bankCode == '09') {
                                return "浦发银行"
                            } else if (bankCode == '07') {
                                return "招商银行"
                            } else if (bankCode == '06') {
                                return "建设银行"
                            } else if (bankCode == '05') {
                                return "农业银行"
                            } else if (bankCode == '04') {
                                return "工商银行"
                            } else if (bankCode == '03') {
                                return "交通银行"
                            } else if (bankCode == '02') {
                                return "邮政储蓄"
                            } else if (bankCode == '01') {
                                return "商业银行"
                            }
                            return "";
                        }
                    }
                }();
                var bizCodeFormat = function () {
                    return {
                        f: function (data, row) {
                            if (data == "1002") {
                                return "普表燃气收费";
                            } else if (data == "1102") {
                                return "垃圾费收费";
                            } else if (data == "1025") {
                                return "IC卡收费";
                            }
                            return "";
                        }
                    }
                }();
                var diffFormat = function () {
                    return {
                        f: function (data, row) {
                            var rgt = isNaN(parseFloat(row.recordGasTotal)) ? 0 : parseFloat(row.recordGasTotal);
                            var bgt = isNaN(parseFloat(row.bankGasTotal)) ? 0 : parseFloat(row.bankGasTotal);
                            var rwt = isNaN(parseFloat(row.recordWasteTotal)) ? 0 : parseFloat(row.recordWasteTotal);
                            var bwt = isNaN(parseFloat(row.bankWasteTotal)) ? 0 : parseFloat(row.bankWasteTotal);

                            var diff = parseFloat(rgt - bgt + rwt - bwt).toFixed(2);
                            if (diff == '0.00') {
                                return "—";
                            } else {
                                return "¥" + parseFloat(diff).toFixed(2);
                            }
                            return "";
                        }
                    }
                }();
                var clearFormat = function () {
                    return {
                        f: function (data, row) {
                            var rgt = isNaN(parseFloat(row.recordGasTotal)) ? 0 : parseFloat(row.recordGasTotal);
                            var bgt = isNaN(parseFloat(row.bankGasTotal)) ? 0 : parseFloat(row.bankGasTotal);
                            var rwt = isNaN(parseFloat(row.recordWasteTotal)) ? 0 : parseFloat(row.recordWasteTotal);
                            var bwt = isNaN(parseFloat(row.bankWasteTotal)) ? 0 : parseFloat(row.bankWasteTotal);
                            var cgt = isNaN(parseFloat(row.monthgasbalance)) ? 0 : parseFloat(row.monthgasbalance);
                            var cwt = isNaN(parseFloat(row.monthwastebalance)) ? 0 : parseFloat(row.monthwastebalance);

                            if (row.balanceStatus == "1") {
                                return "-";
                            }
                            if (row.balanceStatus == "2") {
                                return "¥" +parseFloat(rgt + rwt + cgt + cwt).toFixed(2);
                            }
                            if (row.balanceStatus == "3") {
                                return "¥" +parseFloat(rgt + rwt + cgt + cwt).toFixed(2);
                            }
                            if (row.balanceStatus == "4") {
                                return "¥" +parseFloat(rgt + rwt + cgt + cwt).toFixed(2);
                            }
                            return "-";
                        }
                    }
                }();
                var timeFormat = function () {
                    return {
                        f: function (data, row) {
                            if (data == "" || data == undefined) {
                                return "—";
                            } else {
                                return moment(data).format("YYYY-MM-DD HH:mm:ss");
                            }
                            return "";
                        }
                    }
                }();
                var rowClickedFunction = function (data) {
                    clearDate = data.row.tradeDate;
                    $(this).closest("table").find("tr").css("background-color", "white");

                    $(this).closest("tr").css("background-color", "#f5f5f5");
                    $("#divBalanceContainer").show();
                    $('#divwastedetailtable').html('');
                    $('#divgasdetailtable').html('');
                    RFTable.init(
                        {
                            divname: "divwastedetailtable",
                            //----------------table的选项-------
                            pageSize: 50, 			//Initial pagesize
                            columnPicker: false,         //Show the columnPicker button
                            sorting: false,
                            transition: 'fade',  //(bounce, fade, flip, rotate, scroll, slide).
                            checkboxes: false,           //Make rows checkable. (Note. You need a column with the 'unique' property)
                            checkAllToggle: false,        //Show the check-all toggle//+RQLBuilder.like("KEYY", "a").rql()
                            //----------------基本restful地址---
                            // restbase: 'gasctmarchive/queryArchiveInfo',
                            //      key_column: '',
                            restbase: '/hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&bd={"cols":"a.*,b.createdTime ttime","froms":"gasChgWasteBalanceDetail a, gasChgWasteBankFace b","wheres":"a.tradeAtlId=b.tradeAtlId and a.balanceId=\'' + data.row.balanceId + '\' order by ttime desc","page":true,"limit":10}',
                            //restURL: 'hzqs/hzqrest/gaschgwastebalancedetail?query={"balanceId":"' + data.row.balanceId + '"}',
                            key_column: "balanceDetailId",
                            coldefs: [
                                {
                                    col: "balanceDetailId",
                                    hidden: true,
                                    unique: true
                                },
                                {
                                    col: "bankCode",
                                    friendly: "银行",
                                    sorting: false,
                                    index: 1,
                                    format: bankCodeFormate
                                },
                                {
                                    col: "bizCode",
                                    friendly: "交易类型",
                                    sorting: false,
                                    index: 2,
                                    format: bizCodeFormat
                                },
                                {
                                    col: "serialNo",
                                    friendly: "交易流水号",
                                    sorting: false,
                                    index: 3
                                },
                                {
                                    col: "tradeDate",
                                    friendly: "交易日期",
                                    sorting: false,
                                    index: 4
                                },
                                {
                                    col: "customerCode",
                                    friendly: "客户号",
                                    sorting: false,
                                    index: 5
                                },
                                {
                                    col: "tradeMoney",
                                    friendly: "交易金额",
                                    readonly: "readonly",
                                    format: moneyFormat,
                                    sorting: false,
                                    index: 6
                                },
                                {
                                    col: "ttime",
                                    friendly: "交易时间",
                                    readonly: "readonly",
                                    format: timeFormat,
                                    sorting: false,
                                    index: 7
                                }
                            ],
                        });

                    RFTable.init(
                        {
                            divname: "divgasdetailtable",
                            //----------------table的选项-------
                            pageSize: 50, 			//Initial pagesize
                            columnPicker: false,         //Show the columnPicker button
                            sorting: false,
                            transition: 'fade',  //(bounce, fade, flip, rotate, scroll, slide).
                            checkboxes: false,           //Make rows checkable. (Note. You need a column with the 'unique' property)
                            checkAllToggle: false,        //Show the check-all toggle//+RQLBuilder.like("KEYY", "a").rql()
                            //----------------基本restful地址---
                            // restbase: 'gasctmarchive/queryArchiveInfo',
                            //      key_column: '',
                            restbase: '/hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&bd={"cols":"a.*,b.createdTime ttime","froms":"gasChgGasBalanceDetail a, gasChgGasBankFace b","wheres":"a.tradeAtlId=b.tradeAtlId and a.balanceId=\'' + data.row.balanceId + '\' order by ttime desc","page":true,"limit":10}',
                            //restURL: 'hzqs/hzqrest/gaschggasbalancedetail?query={"balanceId":"' + data.row.balanceId + '"}',
                            key_column: "balanceDetailId",
                            coldefs: [
                                {
                                    col: "balanceDetailId",
                                    hidden: true,
                                    unique: true
                                },
                                {
                                    col: "bankCode",
                                    friendly: "银行",
                                    sorting: false,
                                    index: 1,
                                    format: bankCodeFormate
                                },
                                {
                                    col: "bizCode",
                                    friendly: "交易类型",
                                    sorting: false,
                                    index: 2,
                                    format: bizCodeFormat
                                },
                                {
                                    col: "serialNo",
                                    friendly: "交易流水号",
                                    sorting: false,
                                    index: 3
                                },
                                {
                                    col: "tradeDate",
                                    friendly: "交易日期",
                                    sorting: false,
                                    index: 4
                                },
                                {
                                    col: "customerCode",
                                    friendly: "客户号",
                                    sorting: false,
                                    index: 1
                                },
                                {
                                    col: "tradeMoney",
                                    friendly: "交易金额",
                                    readonly: "readonly",
                                    format: moneyFormat,
                                    sorting: false,
                                    index: 2
                                },
                                {
                                    col: "ttime",
                                    friendly: "交易时间",
                                    readonly: "readonly",
                                    format: timeFormat,
                                    sorting: false,
                                    index: 7
                                }
                            ],
                        });
                }
                $(document).ready(function () {
                    ComponentsPickers.init();

                    $("#find_start_date").val(moment().format("YYYY-MM-DD"));
                    $("#find_end_date").val(moment().format("YYYY-MM-DD"));
                    $.ajax({
                        url: "hzqs/hzqrest/gasbasbank/?query={\"status\":\"1\"}",
                        method: "get",
                        async: false,
                        dataType: "json",
                        success: function (data) {
                            if (data && data.length > 0) {
                                var bankSelect = $("#find_bank");
                                $.each(data, function (i, element) {
                                    bankSelect.append("<option value='" + element.bankCode + "'>" + element.bankName + "</option>")
                                });
                            }
                        }
                    });

                    $("#find_bankbalance").click(function () {
                        $('#divtable').html('');
                        $('#divwastedetailtable').html('');
                        $('#divgasdetailtable').html('');

                        $('#tradedivtable').html('');
                        $('#tradedivwastedetailtable').html('');
                        $('#tradedivgasdetailtable').html('');

                        var endDate = moment($("#find_end_date").val()).add("day", 1).format("YYYY-MM-DD");

                        var whereinfo = " b.status='1' and a.bankCode = b.bankCode and to_date(a.tradeDate,'yyyy-MM-dd') between to_date('" + $("#find_start_date").val() + "','yyyy-MM-dd') and to_date('" + $("#find_end_date").val() + "','yyyy-MM-dd')";
                        var whereinfo2 = "a.bankCode = b.bankCode and to_date(tradeDate,'yyyy-MM-dd') between to_date('" + $("#find_start_date").val() + "','yyyy-MM-dd') and to_date('" + $("#find_end_date").val() + "','yyyy-MM-dd')";
                        if ($("#find_bank").val() != '') {
                            whereinfo += " and a.bankCode='" + $("#find_bank").val() + "'";
                            whereinfo2 += " and a.bankCode='" + $("#find_bank").val() + "'";
                        }

                        whereinfo += " order by a.tradeDate desc,a.bank_gas_total desc,a.bank_waste_total desc,b.bankCode desc"

                        var wheresearchinfo = " where  atl.trade_date >= to_date('" + $("#find_start_date").val() + "','yyyy-MM-dd') and atl.trade_date < to_date('" + endDate + "','yyyy-MM-dd') ";
                        if ($("#find_bank").val() != '') {
                            wheresearchinfo += " and bank.bank_code ='" + $("#find_bank").val() + "' ";
                        }
                        var fromsearch = "(select to_char(atl.trade_date,'yyyyMMdd') trade_date, gas.bank_date,bank.bank_name,bank.bank_code,sum(atl.money) gastotal,count(1) gascount,0 wastetotal,0 wastecount,bank.waste_charge_rate, bank.charge_rate from gasChgGasBankFace gas inner join gas_act_gasfee_atl atl on atl.trade_type in ('CHG','COR') and gas.bank_date is not null and gas.trade_atl_id = atl.gasfee_atl_id inner join gas_bas_bank bank on bank.bank_code = gas.bank_code " + wheresearchinfo +
                            " group by to_char(atl.trade_date,'yyyyMMdd'), gas.bank_date,bank.bank_name,bank.bank_code, bank.charge_rate,bank.waste_charge_rate union all select to_char(atl.trade_date,'yyyyMMdd') trade_date,waste.bank_date,bank.bank_name,bank.bank_code,0 gastotal,0 gascount,sum(atl.money)  wastetotal,count(1) wastecount,bank.waste_charge_rate, bank.charge_rate from gasChgWasteBankFace waste inner join gas_act_wastefee_atl atl on atl.trade_type in ('CHG','COR') and waste.bank_date is not null and waste.trade_atl_id = atl.wastefee_atl_id inner join gas_bas_bank bank on bank.bank_code = waste.bank_code " + wheresearchinfo +
                            " group by to_char(atl.trade_date,'yyyyMMdd'), waste.bank_date,bank.bank_name,bank.bank_code, bank.charge_rate,bank.waste_charge_rate ) allfee group by allfee.bank_date, allfee.bank_name, allfee.bank_code,allfee.charge_rate,allfee.waste_charge_rate,allfee.trade_date order by allfee.bank_code,allfee.trade_date desc,allfee.bank_date desc";
                        var searchbd = {
                            "cols": "'' ismonth,'' category ,allfee.trade_date, allfee.bank_date,allfee.bank_name,allfee.bank_code,sum(allfee.gastotal) gastotal,sum(allfee.gascount) gascount,sum(allfee.wastetotal) wastetotal,sum(allfee.wastecount) wastecount,allfee.charge_rate,allfee.waste_charge_rate",
                            "froms": fromsearch,
                            "page": true,
                            "limit": 50
                        };

                        var sumbd = {
                            "cols": "sum(a.bank_gas_total) gastotal,sum(a.bank_gas_total*b.charge_rate) gasrate,sum(a.bank_waste_total) wastetotal,sum(a.bank_waste_total*b.waste_charge_rate) wasterate,sum(a.bank_gas_count) gascount,sum(a.bank_waste_count) wastecount,sum(a.bank_gas_total+a.bank_waste_total) gaswastesum,sum(a.bank_gas_total*b.charge_rate+a.bank_waste_total*b.waste_charge_rate) gaswasteratesum",
                            "froms": "gasChgBankBalance a,gasBasBank b",
                            "wheres": whereinfo2,
                            "page": false
                        }
                        var sumRet = Restful.findNQ("/hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&proxy=VSELDBC000000J00&bd=" + encodeURIComponent(JSON.stringify(sumbd)));
                        if (sumRet && sumRet.rows && sumRet.rows.length > 0) {
                            $("#gastotal").val(sumRet.rows[0].gastotal);
                            $("#wastetotal").val(sumRet.rows[0].wastetotal);
                            $("#gasrate").val(sumRet.rows[0].gasrate);
                            $("#wasterate").val(sumRet.rows[0].wasterate);
                            $("#gascount").val(sumRet.rows[0].gascount);
                            $("#wastecount").val(sumRet.rows[0].wastecount);
                            $("#gaswastesum").val(sumRet.rows[0].gaswastesum);
                            $("#gaswasteratesum").val(sumRet.rows[0].gaswasteratesum);
                        }

                        var sumfromsearch = "(select gas.bank_date,bank.bank_name,bank.bank_code,sum(atl.money) gastotal,count(1) gascount,0 wastetotal,0 wastecount,bank.waste_charge_rate, bank.charge_rate from gasChgGasBankFace gas inner join gas_act_gasfee_atl atl on atl.trade_type in ('CHG','COR') and gas.bank_date is not null and gas.trade_atl_id = atl.gasfee_atl_id inner join gas_bas_bank bank on bank.bank_code = gas.bank_code " + wheresearchinfo +
                            " group by gas.bank_date,bank.bank_name,bank.bank_code, bank.charge_rate,bank.waste_charge_rate union all select waste.bank_date,bank.bank_name,bank.bank_code,0 gastotal,0 gascount,sum(atl.money)  wastetotal,count(1) wastecount,bank.waste_charge_rate, bank.charge_rate from gasChgWasteBankFace waste inner join gas_act_wastefee_atl atl on atl.trade_type in ('CHG','COR') and waste.bank_date is not null and waste.trade_atl_id = atl.wastefee_atl_id inner join gas_bas_bank bank on bank.bank_code = waste.bank_code " + wheresearchinfo +
                            " group by waste.bank_date,bank.bank_name,bank.bank_code, bank.charge_rate,bank.waste_charge_rate ) allfee ";

                        var sumsearchbd = {
                            "cols": "sum(allfee.gastotal) gastotal,sum(allfee.gastotal*allfee.charge_rate) gasrate,sum(allfee.gascount) gascount,sum(allfee.wastetotal*allfee.waste_charge_rate) wasterate,sum(allfee.wastetotal) wastetotal,sum(allfee.wastecount) wastecount",
                            "froms": sumfromsearch,
                            "page": false,
                        };
                        var sumsearchRet = Restful.findNQ("/hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&proxy=VSELDBC000000J00&bd=" + encodeURIComponent(JSON.stringify(sumsearchbd)));
                        if (sumsearchRet && sumsearchRet.rows && sumsearchRet.rows.length > 0) {
                            $("#tradegastotal").val(sumsearchRet.rows[0].gastotal);
                            $("#tradewastetotal").val(sumsearchRet.rows[0].wastetotal);
                            $("#tradegasrate").val(sumsearchRet.rows[0].gasrate);
                            $("#tradewasterate").val(sumsearchRet.rows[0].wasterate);
                            $("#tradegascount").val(sumsearchRet.rows[0].gascount);
                            $("#tradewastecount").val(sumsearchRet.rows[0].wastecount);
                            $("#tradegaswastesum").val(sumsearchRet.rows[0].gaswastesum);
                            $("#tradegaswasteratesum").val(sumsearchRet.rows[0].gaswasteratesum);
                        }

                        var bd =
                            {
                                "cols": "a.*, (a.bank_gas_total*b.charge_rate) ratemoney,(a.bank_waste_total*b.waste_charge_rate) wasteratemoney,b.bankName",
                                "froms": "gasChgBankBalance a,gasBasBank b",
                                "wheres": whereinfo,
                                "page": true,
                                "limit": 50
                            };
                        var basePath = '';

                        var finwheres = " atl.trade_date >= to_date('" + $("#find_start_date").val() + "','yyyy-MM-dd') and atl.trade_date < to_date('" + endDate + "','yyyy-MM-dd') ";
                        if ($("#find_bank").val() != '') {
                            finwheres += " and bank_code ='" + $("#find_bank").val() + "' ";
                        }
                        var finwheres1 = "to_date(balance.trade_date,'yyyy-MM-dd') between to_date('" + $("#find_start_date").val() + "','yyyy-MM-dd') and to_date('" + $("#find_end_date").val() + "','yyyy-MM-dd')";
                        if ($("#find_bank").val() != '') {
                            finwheres1 += " and bank.bank_code ='" + $("#find_bank").val() + "' ";
                        }
                        var finbd = {
                            "cols": "'' diff,'' bal,balance.balance_status,bank.bank_name,balance.trade_date bank_date,balance.record_gas_total,balance.bank_gas_total,balance.record_waste_total,balance.bank_waste_total,gasbalance.monthgasbalance,wastebalance.monthwastebalance",
                            "froms": "\
                                gas_chg_bank_balance balance \
                                    inner join gas_bas_bank bank \
                                        on balance.bank_code = bank.bank_code \
                                    left join ( \
                                        select  \
                                            bank_code, \
                                            to_char(atl.trade_date,'yyyyMMdd') trade_date, \
                                            sum(money) monthgasbalance \
                                        from gas_act_gasfee_atl atl \
                                            inner join gas_chg_gas_bank_face gas \
                                                on gas.trade_atl_id = atl.gasfee_atl_id  \
                                        where gas.clerk_no = '对账' and " + finwheres +
                            "group by bank_code,to_char(atl.trade_date,'yyyyMMdd') \
                                    ) gasbalance  \
                                        on gasbalance.bank_code = balance.bank_code \
                                            and gasbalance.trade_date = balance.trade_date \
                                    left join ( \
                                        select  \
                                            bank_code, \
                                            to_char(atl.trade_date,'yyyyMMdd') trade_date, \
                                            sum(money) monthwastebalance \
                                        from gas_act_wastefee_atl atl \
                                            inner join gas_chg_waste_bank_face gas \
                                                on gas.trade_atl_id = atl.wastefee_atl_id  \
                                        where gas.clerk_no = '对账' and " + finwheres +
                            "group by bank_code,to_char(atl.trade_date,'yyyyMMdd') \
                                    ) wastebalance \
                                        on wastebalance.bank_code = balance.bank_code \
                                            and wastebalance.trade_date = balance.trade_date \
                                where " + finwheres1 + " order by bank_name,bank_date desc"
                            ,
                            "wheres": "",
                            "page": true,
                            "limit" : 50
                        };

                        xw = XWATable.init(
                            {
                                divname: "divtable",
                                //----------------table的选项-------
                                pageSize: 50, 			//Initial pagesize
                                columnPicker: true,         //Show the columnPicker button
                                sorting: true,
                                transition: 'fade',  //(bounce, fade, flip, rotate, scroll, slide).
                                checkboxes: false,           //Make rows checkable. (Note. You need a column with the 'unique' property)
                                checkAllToggle: true,        //Show the check-all toggle//+RQLBuilder.like("KEYY", "a").rql()
                                //----------------基本restful地址---
                                // restbase: 'gasctmarchive/queryArchiveInfo',
                                //      key_column: '',
                                restURL: 'hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&proxy=VSELDBC000000J00&bd=' + encodeURIComponent(JSON.stringify(bd)),
                                rowClicked: rowClickedFunction,
                                key_column: "balanceId",
                                coldefs: [
                                    {
                                        col: "balanceId",
                                        hidden: true,
                                        unique: true
                                    },
                                    {
                                        col: "bankName",
                                        friendly: "银行",
                                        sorting: false,
                                        index: 1
                                    },
                                    {
                                        col: "tradeDate",
                                        friendly: "对账日期",
                                        sorting: false,
                                        index: 2
                                    },
                                    {
                                        col: "bankGasTotal",
                                        friendly: "银行燃气金额",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 3
                                    },
                                    {
                                        col: "bankGasCount",
                                        friendly: "银行燃气笔数",
                                        readonly: "readonly",
                                        sorting: false,
                                        index: 4
                                    },
                                    {
                                        col: "recordGasTotal",
                                        friendly: "接收燃气金额",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 5
                                    },
                                    {
                                        col: "ratemoney",
                                        friendly: "燃气费手续费",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 5
                                    },
                                    {
                                        col: "recordGasCount",
                                        friendly: "接收燃气笔数",
                                        readonly: "readonly",
                                        sorting: false,
                                        index: 6
                                    },
                                    {
                                        col: "bankWasteTotal",
                                        friendly: "银行垃圾费金额",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 7
                                    },
                                    {
                                        col: "bankWasteCount",
                                        friendly: "银行垃圾费笔数",
                                        readonly: "readonly",
                                        sorting: false,
                                        index: 8
                                    },
                                    {
                                        col: "recordWasteTotal",
                                        friendly: "接收垃圾费金额",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 9
                                    },
                                    {
                                        col: "wasteratemoney",
                                        friendly: "垃圾费手续费",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 9
                                    },
                                    {
                                        col: "recordWasteCount",
                                        friendly: "接收垃圾费笔数",
                                        readonly: "readonly",
                                        sorting: false,
                                        index: 10
                                    },
                                    {
                                        col: "balanceStatus",
                                        friendly: "对账结果",
                                        readonly: "readonly",
                                        sorting: false,
                                        format: balanceResultFormat,
                                        index: 11
                                    }
                                ],
                            });

                            $("#tradedivtable").html("");
                        xw1 = XWATable.init(
                            {
                                divname: "tradedivtable",
                                //----------------table的选项-------
                                pageSize: 50, 			//Initial pagesize
                                columnPicker: true,         //Show the columnPicker button
                                sorting: true,
                                transition: 'fade',  //(bounce, fade, flip, rotate, scroll, slide).
                                checkboxes: false,           //Make rows checkable. (Note. You need a column with the 'unique' property)
                                checkAllToggle: true,        //Show the check-all toggle//+RQLBuilder.like("KEYY", "a").rql()
                                //----------------基本restful地址---
                                // restbase: 'gasctmarchive/queryArchiveInfo',
                                //      key_column: '',
                                restURL: 'hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&proxy=VSELDBC000000J00&bd=' + encodeURIComponent(JSON.stringify(searchbd)),
                                coldefs: [
                                    {
                                        col: "bankName",
                                        friendly: "银行",
                                        sorting: false,
                                        index: 1
                                    },
                                    {
                                        col: "bankDate",
                                        friendly: "银行对账日期",
                                        sorting: false,
                                        index: 3
                                    },
                                    {
                                        col: "tradeDate",
                                        friendly: "交易日期",
                                        sorting: false,
                                        index: 2
                                    },
                                    {
                                        col: "gastotal",
                                        friendly: "燃气金额",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 5
                                    },
                                    {
                                        col: "gascount",
                                        friendly: "燃气笔数",
                                        readonly: "readonly",
                                        sorting: false,
                                        index: 6
                                    },
                                    {
                                        col: "wastetotal",
                                        friendly: "垃圾费金额",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 9
                                    },
                                    {
                                        col: "wastecount",
                                        friendly: "垃圾费笔数",
                                        readonly: "readonly",
                                        sorting: false,
                                        index: 10
                                    },
                                    {
                                        col: "ismonth",
                                        friendly: "是否跨月",
                                        readonly: "readonly",
                                        sorting: false,
                                        format: isMonthFormat,
                                        index: 11
                                    },
                                    {
                                        col: "category",
                                        friendly: "类型",
                                        readonly: "readonly",
                                        sorting: false,
                                        format: categoryFormat,
                                        index: 12
                                    }
                                ],
                            });

                            $("#findivtable").html("");
                        xf = XWATable.init(
                            {
                                divname: "findivtable",
                                //----------------table的选项-------
                                pageSize: 50, 			//Initial pagesize
                                columnPicker: true,         //Show the columnPicker button
                                sorting: true,
                                transition: 'fade',  //(bounce, fade, flip, rotate, scroll, slide).
                                checkboxes: false,           //Make rows checkable. (Note. You need a column with the 'unique' property)
                                checkAllToggle: true,        //Show the check-all toggle//+RQLBuilder.like("KEYY", "a").rql()
                                //----------------基本restful地址---
                                // restbase: 'gasctmarchive/queryArchiveInfo',
                                //      key_column: '',
                                restURL: 'hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&proxy=VSELDBC000000J00&bd=' + encodeURIComponent(JSON.stringify(finbd)),
                                coldefs: [
                                    {
                                        col: "balanceStatus",
                                        friendly: "对账状态",
                                        sorting: false,
                                        format: balanceStatusFormat,
                                        index: 1
                                    },
                                    {
                                        col: "bankName",
                                        friendly: "银行",
                                        sorting: false,
                                        index: 2
                                    },
                                    {
                                        col: "bankDate",
                                        friendly: "银行对账日期",
                                        sorting: false,
                                        index: 3
                                    },
                                    {
                                        col: "recordGasTotal",
                                        friendly: "燃气金额",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 4
                                    },
                                    {
                                        col: "recordWasteTotal",
                                        friendly: "垃圾费金额",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 5
                                    },
                                    {
                                        col: "monthgasbalance",
                                        friendly: "燃气费冲销金额",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 7
                                    },
                                    {
                                        col: "monthwastebalance",
                                        friendly: "垃圾费冲销金额",
                                        readonly: "readonly",
                                        format: moneyFormat,
                                        sorting: false,
                                        index: 8
                                    },
                                    {
                                        col: "diff",
                                        friendly: "差额",
                                        readonly: "readonly",
                                        sorting: false,
                                        format: diffFormat,
                                        index: 6
                                    },
                                    {
                                        col: "bal",
                                        friendly: "清算额",
                                        readonly: "readonly",
                                        sorting: false,
                                        format: clearFormat,
                                        index: 9
                                    }
                                ],
                            });
                    });
                });

</script>
<script type="text/javascript" src="../assets/global/plugins/select2/select2.js"></script>

</html>