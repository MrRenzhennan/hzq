<!DOCTYPE html>
<!--[if IE 8]>
<html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!-->
<html lang="zh">
<!--<![endif]-->

<!-- BEGIN HEAD -->

<head>
    <title>pos机查询</title>
    <script src="../pages/scripts/basepath.js"></script>
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-select/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/select2/select2.css">
    <script src="../pages/scripts/header.js"></script>
    <meta http-equiv="content-type" content="text/html" charset="utf-8" />
    <link href='../assets/global/plugins/jquery-watable/watable.css' rel='stylesheet' />
    <link href='../assets/global/plugins/jquery-watable/animate.min.css' rel='stylesheet' />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.css"
    />
    <link href='../assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css' rel='stylesheet' />

    <!--datapicker css start-->
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-datepicker/css/datepicker3.css" />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css"
    />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-colorpicker/css/colorpicker.css" />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-daterangepicker/daterangepicker-bs3.css"
    />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css" />
    <!--datapicker end-->
</head>
<!-- END HEAD -->

<body class="page-header-fixed page-quick-sidebar-over-content">

    <!-- 标题栏开始 -->
    <div class="page-header navbar navbar-fixed-top">
        <script>
            $.include("pages/partial/menu.shtml");
        </script>
    </div>
    <!-- 标题栏结束 -->
    <div class="clearfix"></div>
    <div class="page-container">
        <!-- 左侧菜单开始 -->
        <div class="page-sidebar-wrapper">
            <script>
                $.include("pages/partial/sidebar.shtml");
            </script>
        </div>
        <!-- 左侧菜单结束 -->
        <!-- 主内容开始 -->
        <div class="page-content-wrapper">
            <div class="page-content">
                <!--内容头开始-->
                <script>$.include("common/navigation_bar.shtml");</script>
                <!-- 内容头结束-->

                <!-- 内容开始-->

                <div class="container col-sm-12" style="padding-bottom:0px">
                    <div class="row">
                        <div class="col-sm-5 form-group">
                            <div class="btn-group input-group pull-left">
                                <div class="input-group-addon">开始日期:</div>
                                <div class="input-group input-large date-picker input-daterange" data-date-format="yyyy-mm-dd">
                                    <input id="find_start_date" type="text" class="form-control">
                                    <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                    <span class="input-group-addon">至</span>
                                    <input id="find_end_date" type="text" class="form-control">
                                    <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-3 form-group">
                            <div class="btn-group input-group pull-left">
                                <div class="input-group-addon">营业网点:</div>
                                <select id="find_chargeUnitId" class="form-control input-small select2me" data-placeholder="请选择银行">
                                    <option value="">全部</option>
                                </select>
                                <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                            </div>
                        </div>
                        <div class="col-sm-3 form-group">
                            <div class="btn-group input-group">
                                <div class="input-group-addon">营业员：</div>
                                <select id="find_employeeName" class="form-control input-small select2me" data-placeholder="请选择...">
                                <option value="">全部</option>
                            </select>
                                <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <button id="find_pos" type="button" class="btn yellow">
                                查询 <i class="fa fa-search"></i>
                            </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="container-fluid">
                    <!--/row-->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label col-md-3">POS机收费总金额:</label>
                                <div class="col-md-6">
                                    <input id="pos_amount" type="text" class="form-control" placeholder="" value="" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label col-md-3">POS机收费户数:</label>
                                <div class="col-md-6">
                                    <input id="pos_count" type="text" class="form-control" placeholder="" value="" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="divtable" class="table-responsive container-fluid col-md-12">
                    </div>
                </div>


                <div class="container-fluid">

                    <div id="divgasdetailtable" class="table-responsive container-fluid col-md-12">

                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- 主内容结束 -->
    </div>
    <script type="text/javascript">
                $.include("pages/partial/xwatable-form.shtml")
    </script>

    <!-- 底边栏开始 -->
    <script>
        $.include("pages/partial/foot.shtml");
    </script>
    <!--英尺-->
    <!-- 底边栏结束 -->
    <div class="modal fade" id="hzqModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog">
            <div id="mcontent" class="modal-content">
            </div>
        </div>
    </div>
</body>


<script>
        $.include("pages/partial/scripts.shtml");

</script>
<!--跳到原稿-->
<script src="../assets/global/plugins/jquery.cokie.min.js" type="text/javascript"></script>
<script type="text/javascript" src="../assets/global/plugins/jquery-watable/jquery.watable.js"></script>
<script type="text/javascript" src="../pages/scripts/rqlbuilder.js"></script>
<script type="text/javascript" src="../pages/scripts/xwatable.js"></script>
<script type="text/javascript" src="../pages/scripts/refhelper.js"></script>

<!--datapicker start-->
<script type="text/javascript" src="../assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/clockface/js/clockface.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/moment.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<script src="../assets/admin/pages/scripts/components-pickers.js"></script>

<!--datapicker end-->

<script type="text/javascript">
    var userInfo = JSON.parse(localStorage.getItem('user_info'));


    var moneyFormat = function () {
        return {
            f: function (data, row) {
                if (isNaN(parseFloat(data))) {
                    return "";
                } else {
                    return "¥" + parseFloat(data).toFixed(4);
                }
            }
        }
    }();

    var Detail = function () {
        return {
            f: function (val, row) {
                return "<button onclick='showDetail(\"" + row.chargeUnitId + "\",\"" + row.createdTime + "\")'>" + "&nbsp明细" + "</button>";
            }
        }
    }();
    var timeFormat = function () {
        return {
            f: function (data, row) {
                if (data == "" || data == undefined) {
                    return "—";
                } else {
                    return moment(data).format("YYYY-MM-DD HH:mm:ss");
                }
                return "";
            }
        }
    }();

    function showDetail(unit, time) {
        var name = '';
        $("#divgasdetailtable").show();
        $("#divgasdetailtable").html('');
        var beginDate; // yyyy-MM-dd
        var endDate; // yyyy-MM-dd

        beginDate = time;
        endDate = moment(beginDate).add('days', 1).format('YYYY-MM-DD');
        //console.log(endDate);
        var wheredetail = "charge_type_id = '2' and createdTime between to_date('" + beginDate + "','yyyy-MM-dd') and to_date('" + endDate + "','yyyy-MM-dd')  and vw.chargeUnitId='" + unit + "'";

        if (!name || name == '' || name == 'undefined') {
            name = $('#find_employeeName option:selected').val();
        }

        if (name) {
            wheredetail += " and vw.userId = '" + name + "'";
        }
        var bd =
            {
                "cols": "money,customerCode,createdTime,customerName,chargeUnitName,employeeName",
                "froms": "vwChgDayBalanceAll vw",
                "wheres": wheredetail+"order by vw.createdTime desc",
                "page": true
            };

        xw = XWATable.init(
            {
                divname: "divgasdetailtable",
                //----------------table的选项-------
                pageSize: 20, 			//Initial pagesize
                columnPicker: true,         //Show the columnPicker button
                sorting: true,
                transition: 'fade',  //(bounce, fade, flip, rotate, scroll, slide).
                checkboxes: false,           //Make rows checkable. (Note. You need a column with the 'unique' property)
                checkAllToggle: true,        //Show the check-all toggle//+RQLBuilder.like("KEYY", "a").rql()
                //----------------基本restful地址---
                // restbase: 'gasctmarchive/queryArchiveInfo',
                //      key_column: '',
                restURL: 'hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&proxy=VSELDBC000000J00&bd=' + encodeURIComponent(JSON.stringify(bd)),
                //rowClicked: rowClickedFunction,
                key_column: "customerCode",
                coldefs: [
                    {
                        col: "customerCode",
                        friendly: "客户编号",
                        sorting: false,
                        index: 1
                    },
                    {
                        col: "customerName",
                        friendly: "客户姓名",
                        sorting: false,
                        index: 2
                    },
                    {
                        col: "money",
                        friendly: "金额",
                        sorting: false,
                        index: 3
                    },
                    {
                        col: "createdTime",
                        friendly: "收费时间",
                        sorting: false,
                        index: 4
                    },
                    {
                        col: "chargeUnitName",
                        friendly: "营业网点",
                        sorting: false,
                        index: 5
                    },
                    {
                        col: "employeeName",
                        friendly: "营业员",
                        sorting: false,
                        index: 5
                    }
                ]
            });
    }



    $(document).ready(function () {
        ComponentsPickers.init();

        $("#find_start_date").val(moment().format("YYYY-MM-DD"));
        $("#find_end_date").val(moment().format("YYYY-MM-DD"));
        var isNotYYY = true;
        if (userInfo.station_id && (userInfo.station_id == "4" || userInfo.station_id == "5")) {
            isNotYYY = false;
            var opts = '';
            if (userInfo.station_id == "4") {
                $("#find_employeeName").html('<option selected="selected" value="' + userInfo.userId + '">班长-' + userInfo.employee_name + '</option>');
            } else {
                $("#find_employeeName").html('<option selected="selected" value="' + userInfo.userId + '">营业员-' + userInfo.employee_name + '</option>');
            }
            $.ajax({
                type: 'get',
                url: '/hzq_rest/gasbizchargeunit/' + userInfo.charge_unit_id,
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                async: false,
                success: function (data, textStatus, xhr) {
                    if (xhr.status == 200) {
                        var opts = "";
                        opts += '<option selected="selected"  value="' + data.chargeUnitId + '">' + data.chargeUnitName + '</option>';
                        $("#find_chargeUnitId").html(opts);
                        $("#find_employeeName").val(data.chargeUnitId).trigger('change');
                        //$("#find_chargeUnitId").attr("disabled", true);
                    } else if (xhr.status == 403) {

                    }
                },
                error: function (err) {
                    if (err.status == 403) {

                    }
                }
            });
        }

        if (isNotYYY == true) {
            $.ajax({
                type: 'get',
                url: "/hzq_rest/gasbizchargeunit/?query={\"status\":\"1\"}",
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                async: false,
                success: function (data, textStatus, xhr) {
                    if (xhr.status == 200) {
                        var opts = '<option value=""></option>';
                        var rows = data;
                        for (var i = 0; i < rows.length; i++) {
                            opts += '<option value="' + rows[i].chargeUnitId + '">' + rows[i].chargeUnitName + '</option>';
                        }
                        $("#find_chargeUnitId").html(opts);
                    } else if (xhr.status == 403) {

                    }
                },
                error: function (err) {
                    if (err.status == 403) {

                    }
                }
            });
        }
        $("#find_chargeUnitId").change(function () {
            if ($("#find_chargeUnitId").val() == "") {
                var opts = '<option value="" >无</option>';
                $("#find_employeeName").html(opts);
                $("#find_employeeName").select2("val", "");
                $("#find_employeeName").select2("open");
                return;
            }
            var f_u_s = RQLBuilder.and([
                RQLBuilder.equal("chargeUnitId", $("#find_chargeUnitId").val())
                , RQLBuilder.or([
                    RQLBuilder.equal("stationId", "5")
                    , RQLBuilder.equal("stationId", "4")
                ])
            ]);
            $.ajax({
                type: 'get',
                url: '/hzq_rest/gassysuser?query=' + f_u_s.rql(),
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                async: false,
                success: function (data, textStatus, xhr) {
                    if (xhr.status == 200) {
                        var opts = '';
                        var rows = data;
                        if (!rows.length || rows.length == 0) {
                            opts = '<option value="" >无</option>';
                        } else {
                            opts = '<option value="" >全部</option>';
                            for (var i = 0; i < rows.length; i++) {
                                if (rows[i].stationId == "4") {
                                    opts += '<option value="' + rows[i].userId + '">班长-' + rows[i].employeeName + '</option>';
                                } else {
                                    opts += '<option value="' + rows[i].userId + '">营业员-' + rows[i].employeeName + '</option>';
                                }

                            }
                        }
                        $("#find_employeeName").html(opts);
                        $("#find_employeeName").select2("open");
                    } else if (xhr.status == 403) {

                    }
                },
                error: function (err) {
                    if (err.status == 403) {

                    }
                }
            });
        });

        function toAmount(amount) {
            if (amount != '' && amount != null) {
                return parseFloat(amount).toFixed(4);
            }
        }

        $("#find_pos").click(function () {
            $('#divtable').html('');
            $('#divgasdetailtable').html('');

            var wheres = "to_date(to_char(created_time,'yyyy-MM-dd'),'yyyy-MM-dd') between to_date('" + $("#find_start_date").val() + "','yyyy-MM-dd') and to_date('" + $("#find_end_date").val() + "','yyyy-MM-dd') and chargeTypeId='2'";
            if ($("#find_chargeUnitId").val() != '') {
                wheres += " and chargeUnitId='" + $("#find_chargeUnitId").val() + "'";
            }
            if ($("#find_employeeName").val() != '') {
                wheres += " and userId='" + $("#find_employeeName").val() + "'";
            }

            //wheres += " group by to_char(createdTime,'yyyy-MM-dd'),chargeUnitName"
            //wheres += " group by chargeUnitName"
            var bd =
                {
                    "cols": "sum(money) as amount,chargeUnitId,count(1) as count,to_char(createdTime,'yyyy-MM-dd') createdTime,chargeUnitName",
                    "froms": "vwChgDayBalanceAll vw",
                    "wheres": wheres + "group by chargeUnitId,chargeUnitName,to_char(createdTime,'yyyy-MM-dd') order by createdTime desc",
                    "page": true,
                    "limit": 20
                };
            var b =
                {
                    "cols": "sum(money) as amount,count(1) as count",
                    "froms": "vwChgDayBalanceAll vw",
                    "wheres": wheres+"order by createdTime desc",
                    "page": false
                };
            var basePath = '';
            //console.log(b);
            $.ajax({
                type: 'get',
                url: '/hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&bd=' + JSON.stringify(b),
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                async: false,
                success: function (data, textStatus, xhr) {
                    if (xhr.status == 200) {
                        var rows = data.rows;
                        if (!data.rows || !rows.length || rows.length == 0) {
                            $("#pos_amount").val("");
                            $("#pos_count").val("");

                        } else {
                            var all_amount = 0;
                            var all_count = 0;

                            $("#pos_amount").val(toAmount(rows[0].amount));
                            $("#pos_count").val(rows[0].count);
                        }

                    } else if (xhr.status == 403) {

                    }
                },
                error: function (err) {
                    if (err.status == 403) {

                    }
                }
            });

            xw = XWATable.init(
                {
                    divname: "divtable",
                    //----------------table的选项-------
                    pageSize: 20, 			//Initial pagesize
                    columnPicker: true,         //Show the columnPicker button
                    sorting: true,
                    transition: 'fade',  //(bounce, fade, flip, rotate, scroll, slide).
                    checkboxes: false,           //Make rows checkable. (Note. You need a column with the 'unique' property)
                    checkAllToggle: true,        //Show the check-all toggle//+RQLBuilder.like("KEYY", "a").rql()
                    //----------------基本restful地址---
                    // restbase: 'gasctmarchive/queryArchiveInfo',
                    //      key_column: '',
                    restURL: 'hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&proxy=VSELDBC000000J00&bd=' + encodeURIComponent(JSON.stringify(bd)),
                    //rowClicked: rowClickedFunction,
                    key_column: "customerCode",
                    coldefs: [
                        {
                            col: "customerCode",
                            hidden: true,
                            unique: true
                        },
                        {
                            col: "amount",
                            friendly: "总金额",
                            sorting: false,
                            index: 3
                        },
                        {
                            col: "count",
                            friendly: "总笔数",
                            sorting: false,
                            index: 4
                        },
                        {
                            col: "createdTime",
                            friendly: "收费日期",
                            sorting: false,
                            index: 2
                        },
                        {
                            col: "chargeUnitName",
                            friendly: "营业网点",
                            sorting: false,
                            index: 1
                        },
                        {
                            col: "operation",
                            friendly: "操作", //更新时间
                            format: Detail,
                            nonedit: "noeidt",
                            index: 5
                        }
                    ]
                });
        });
    });

</script>
<script type="text/javascript" src="../assets/global/plugins/select2/select2.js"></script>

</html>