<!DOCTYPE html>
<!--[if IE 8]>
<html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!-->
<html lang="zh">
<!--<![endif]-->

<!-- BEGIN HEAD -->

<head>
    <title>下线表管理</title>
    <base href="../../">
    <script src="pages/scripts/header.js"></script>
    <meta http-equiv="content-type" content="text/html" charset="utf-8" />
    <link href='assets/global/plugins/jquery-watable/watable.css' rel='stylesheet' />
    <link href='assets/global/plugins/jquery-watable/animate.min.css' rel='stylesheet' />

    <!--datapicker start-->
    <link rel="stylesheet" type="text/css" href="assets/global/plugins/bootstrap-datepicker/css/datepicker3.css" />
    <link rel="stylesheet" type="text/css" href="assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css"
    />
    <link rel="stylesheet" type="text/css" href="assets/global/plugins/bootstrap-colorpicker/css/colorpicker.css" />
    <link rel="stylesheet" type="text/css" href="assets/global/plugins/bootstrap-daterangepicker/daterangepicker-bs3.css" />
    <link rel="stylesheet" type="text/css" href="assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css" />
    <!--datapicker end-->

    <link rel="stylesheet" type="text/css" href="assets/global/plugins/bootstrap-select/bootstrap-select.min.css" />
    <link rel="stylesheet" type="text/css" href="assets/global/plugins/select2/select2.css" />
    <link rel="stylesheet" type="text/css" href="assets/global/plugins/jquery-multi-select/css/multi-select.css" />
    <link href="assets/global/css/components.css" rel="stylesheet" type="text/css" />
    <link href="assets/global/css/plugins.css" rel="stylesheet" type="text/css" />
    
    <link href="assets/global/plugins/bootstrap-fileinput/fileinput.min.css" rel="stylesheet">

    <style>
        #archive>div {
            margin-bottom: 15px;
        }

        #divtable td:last-child {
            cursor: pointer;
        }

        table {
            cursor: default;
        }
    </style>
</head>
<!-- END HEAD -->

<body class="page-header-fixed page-quick-sidebar-over-content">

    <!-- 标题栏开始 -->
    <div class="page-header navbar navbar-fixed-top">
        <script>$.include("pages/partial/menu.shtml");</script>
    </div>
    <!-- 标题栏结束 -->
    <div class="clearfix"></div>
    <div class="page-container">
        <!-- 左侧菜单开始 -->
        <div class="page-sidebar-wrapper">
            <script>$.include("pages/partial/sidebar.shtml");</script>
        </div>
        <!-- 左侧菜单结束 -->

        <!-- 主内容开始 -->
        <div class="page-content-wrapper">
            <div class="page-content">
                <!--内容头开始-->
                <div class="row">
                    <div class="col-md-12">
                        <ul class="page-breadcrumb breadcrumb">
                        </ul>
                    </div>
                </div>
                <!-- 内容头结束-->

                <!-- 内容开始-->


                <!-- 内容结束-->
                <div class="tabbable tabbable-custom tabbable-custom-profile col-md-12" style="padding-bottom:0px">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a href="#tab22" data-toggle="tab" style="font-size: 14px;color: blue;">
                                重新上线申请的表具信息 </a>
                        </li>
                    </ul>
                    <!--/row-->
                    <div class="tab-content">
                        <div class="tab-pane active" id="tab22">
                            <div class="portlet-body">
                                <!-- begin form-->


                                <div class="row">
                                    <div class="col-sm-3 form-group">
                                        <div class="btn-group input-group  input-select2me">
                                            <div class="input-group-addon">仓库名称:</div>
                                            <input id="meterName" type="text" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-3 form-group">
                                        <div class="btn-group input-group input-select2me">
                                            <div class="input-group-addon">表编号:</div>
                                            <input id="meterCode" type="text" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-3 form-group">
                                        <div class="btn-group input-group  input-select2me">
                                            <div class="input-group-addon">表具类型:</div>
                                            <input id="meterTypeId" type="text" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-3 form-group">
                                        <div class="btn-group input-group  input-select2me">
                                            <div class="input-group-addon">物品种类:</div>
                                            <input id="resKind" type="text" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-3 form-group">
                                        <div class="btn-group input-group  input-select2me">
                                            <div class="input-group-addon">厂家名称:</div>
                                            <input id="factoryName" type="text" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-3 form-group">
                                        <div class="btn-group input-group  input-select2me">
                                            <div class="input-group-addon">表具规格型号:</div>
                                            <input id="meterModelId" type="text" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-3 form-group">
                                        <div class="btn-group input-group  input-select2me">
                                            <div class="input-group-addon">流量范围:</div>
                                            <input id="flowRange" type="text" class="inputclear form-control" readonly>
                                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 form-group">
                                        <div class="btn-group input-group" style="width: 100% !important;">
                                            <div class="input-group-addon">申请原因:</div>
                                            <select id="reason" name="direction"
                                                    class="select2-container form-control select2me"
                                                    data-placeholder="请选择..." >
                                                <option value=""></option>
                                                <option value="1">维修</option>
                                                <option value="2">操作错误</option>
                                            </select>
                                        </div>
                                    </div>
                                    
				                    <div class="col-md-12 form-group">
                                        <div class="btn-group input-group" style="width: 100% !important;">
                                            <div class="input-group-addon">备注:</div>
					                        <textarea id="remark" value="" maxlength="2000" size="2000" class="col-md-12 form-control" style="height: 100px;"></textarea>
                                        </div>
                                    </div>
                                    <script>$.include("common/gpyupload.shtml")</script>
                                </div>

                                <!--end form-->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 form-group" style="margin-left: 35%">
                    <div class="btn-group form-group">
                        <button id="submit_btn" class="btn blue off">
                            提交
                        </button>
                    </div>
                    <div class="btn-group form-group">
                        <button id="back_btn" class="btn blue off">
                            返回
                        </button>
                    </div>
                </div>

                <div class="clearfix">
                </div>
            </div>
        </div>
        <!-- 主内容结束 -->
    </div>



    <script type="text/javascript">$.include("pages/partial/xwatable-form.shtml")</script>
</body>


<script>$.include("pages/partial/scripts.shtml");</script>
<script src="assets/global/plugins/jquery.cokie.min.js" type="text/javascript"></script>
<script type="text/javascript" src="assets/global/plugins/jquery-watable/jquery.watable.js"></script>
<script type="text/javascript" src="pages/scripts/rqlbuilder.js"></script>
<script type="text/javascript" src="pages/scripts/xwatable.js"></script>
<script type="text/javascript" src="pages/scripts/refhelper.js"></script>

<!--datapicker start-->
<script type="text/javascript" src="assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
<script type="text/javascript" src="assets/global/plugins/clockface/js/clockface.js"></script>
<script type="text/javascript" src="assets/global/plugins/bootstrap-daterangepicker/moment.min.js"></script>
<script type="text/javascript" src="assets/global/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
<script type="text/javascript" src="assets/global/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
<script type="text/javascript" src="assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>

<script type="text/javascript" src="assets/global/plugins/bootstrap-select/bootstrap-select.min.js"></script>
<script type="text/javascript" src="assets/global/plugins/select2/select2.min.js"></script>
<script type="text/javascript" src="assets/global/plugins/jquery-multi-select/js/jquery.multi-select.js"></script>

<script src="pages/scripts/jquery.json.min.js"></script>
<script type="text/javascript" src="pages/scripts/jquery.serialize-object.min.js"></script>
<script src="assets/admin/pages/scripts/components-pickers.js"></script>

<script src="mods/timeslot.js"></script>
<script src="mods/basismanage.js"></script>
<script src="mods/ctm.js"></script>
<script type="text/javascript">


    SideBar.init();
    SideBar.activeCurByPage("customer/dm/offline.html");

    var href = document.location.href;
    var args = href.split("?");

    var meterId = args[1];

    $(function () {

        var userinfo = JSON.parse(localStorage.getItem('user_info'));
        var areaId = userinfo.area_id;
        var userId = userinfo.userId;
        console.log(userinfo);
        var meterNo;

        $.ajax({
            url: "hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            type: "POST",
            data: JSON.stringify({
                cols: "mf.factory_name,mm.meterNo,mms.meter_model_name,mr.reskind_name,mmt.meter_type_name, md.depository_name,mmf.flow_name",
                froms: "gas_mtr_meter mm ,gas_mtr_factory mf, gas_mtr_meterspec mms,gas_mtr_reskind mr,gas_mtr_meter_type mmt,gas_mtr_depository md,gas_mtr_meter_flow mmf",
                wheres: " mm.factory_id=mf.factory_id and mms.meter_model_id = mm.meter_model_id and mr.reskind_id =mm.reskind_id and mm.meter_id = '" + meterId + "' and md.depository_id = mm.depository_id and mmt.meter_type_id = mm.meter_type_id and mmf.meter_flow_id = mm.flow_range",
                page: "false",
                limit: 1
            }),
            success: function (data) {
                var datas = data.rows[0];
                console.log(datas);
                $('#meterName').val(datas.depositoryName);//仓库
                $('#meterCode').val(datas.meterNo);//表编号
                $('#meterTypeId').val(datas.meterTypeName);//表具类型
                $('#factoryName').val(datas.factoryName);//厂家
                $('#meterModelId').val(datas.meterModelName);//表具规格
                $('#resKind').val(datas.reskindName);//物品种类
                $('#flowRange').val(datas.flowName);//流量
                meterNo = datas.meterNo;
            },
            error: function (err) {

            }
        });

        $('#back_btn').click(function () {
            window.location = "/customer/dm/meteroffline.html";
        });
        //提交
        $("#submit_btn").on('click', function () {
            var uniqueid = $.md5(JSON.stringify(userinfo.userId) + new Date().getTime());
            console.log(userinfo.userId);
			var reason = $("#reason").val();
			if(!reason){
				bootbox.alert("<br><center><h4>请选择申请原因</h4></center><br>");
				return;
			}
			if (!gpypictureId) {
		        fileId = "";
		    }
			if(!fileId){
				bootbox.alert("<br><center><h4>请上传相关照片</h4></center><br>");
				return;
			}
            //下线表重新上线申请记录表
            apply = {
                "meterReonlineId": uniqueid,//主键
                "meterId": meterId,
                "flowInstId": uniqueid,
                "areaId": userinfo.area_id,
                "createdTime": new Date().getTime(),
                "createdBy": userId,
                "modified_time": new Date().getTime(),
                "modifiedBy": userId,
                "status": "0",
                "reason":reason,
                "remark":$("#remark").val(),
                "files":fileId
            };
            //流程
            var flowjson = {
                "flow_def_id": "METERONLINE",
                "ref_no": uniqueid, // 唯一标识
                "operator": userinfo.userId, // 流程提交人
                "be_orgs": userinfo.area_id, // 所属角色
                "flow_inst_id": uniqueid, // 流程实例id
                "propstr2048": JSON.stringify({
                    "meter_reonline_id": uniqueid
                }), // 业务参数
                "prop1str64": moment().format("YYYY-MM-DD HH:mm:ss"),
                "prop2str64": meterNo, // 代办名称
                "propstr128": userinfo.employee_name == "" || userinfo.employee_name == undefined ? userinfo.userId : userinfo.employee_name,  // loginName
                "propstr256": "", //
                "override_exists": false
            }
            console.log(apply);
            var result = Restful.insert(hzq_rest + "gasmtrmeterreonline", apply)
            var flow_result = Restful.insert("/hzqs/psm/pbisn.do?fh=VFLSCGC000000J00&bd={}&resp=bd", flowjson)


           if (result['success'] && flow_result.retcode == "0") {
 
                 //window.location = "/customer/dm/meteroffline.html";
                 bootbox.alert({
                     buttons: {
                         ok: {
                             className: 'btn-myStyle'
                         }
                     },
                     message: '重新上线申请提交成功',
                     callback: function () {
 
                         window.location = "/customer/dm/meteroffline.html";
 
                     },
                 });
             } else {
                 bootbox.alert("<br><center><h4>重新上线申请提交失败</h4></center><br>");
             } 

            /* if (result['success']) {
                if (flow_result.retcode == "0") {
                    bootbox.alert({
                        buttons: {
                            ok: {
                                className: 'btn-myStyle'
                            }
                        },
                        message: '重新上线申请提交成功',
                        callback: function () {

                            window.location = "/customer/dm/meteroffline.html";

                        },
                    });
                }else{
                    
                }
            } */


        });

    })
</script>
<!-- End of User Script-->

</html>