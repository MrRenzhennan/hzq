<!DOCTYPE html>
<!--[if IE 8]>
<html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!-->
<html lang="zh">
<!--<![endif]-->
<!--
* @Author: king.camulos 
* @Date: 2017-11-30 10:38:59 
* @Last Modified by:   king.camulos 
* @Last Modified time: 2017-11-30 10:38:59 
-->
<!-- BEGIN HEAD -->
<head>
    <title>用户同期环比销售量查询</title>
    <script src="../pages/scripts/basepath.js"></script>
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-select/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/select2/select2.css">
    <script src="../pages/scripts/header.js"></script>
    <meta http-equiv="content-type" content="text/html" charset="utf-8"/>
    <link href='../assets/global/plugins/jquery-watable/watable.css' rel='stylesheet'/>
    <link href='../assets/global/plugins/jquery-watable/animate.min.css' rel='stylesheet'/>
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.css"/>
    <link href='../assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css' rel='stylesheet'/>

    <!--datapicker css start-->
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-datepicker/css/datepicker3.css"/>
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css"/>
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-colorpicker/css/colorpicker.css"/>
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-daterangepicker/daterangepicker-bs3.css"/>
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css"/>
    <!--datapicker end-->

    <link rel="stylesheet" href="/statement/css/3.3.7/bootstrap.min.css">
    <link href='../assets/global/css/bootstrap-monthpicker.css' rel='stylesheet'/>
    <!-- END THEME STYLES -->
    <style>
        @media print {
            .noneprint {
                display: none;
            }
        }

        .tabPrint td {
            border-left: #000000 solid 1px;
            border-top: #000000 solid 1px;
            height: 21px;
        }

        table.tabPrint {
            border-right: #000000 solid 1px;
            border-bottom: #000000 solid 1px;
        }

        .nextPage {
            page-break-after: always;
        }

        .linetd {
            border-bottom: solid 1px #000;
        }
    </style>
</head>
<!-- END HEAD -->

<body class="page-header-fixed page-quick-sidebar-over-content">

<!-- 标题栏开始 -->
<div class="page-header navbar navbar-fixed-top">
    <script>$.include("pages/partial/menu.shtml");</script>
</div>
<!-- 标题栏结束 -->
<div class="clearfix"></div>
<div class="page-container">
    <!-- 左侧菜单开始 -->
    <div class="page-sidebar-wrapper">
        <script>$.include("pages/partial/sidebar.shtml");</script>
    </div>
    <!-- 左侧菜单结束 -->

    <!-- 主内容开始 -->
    <div class="page-content-wrapper">
        <div class="page-content">
            <!--内容头开始-->
            <!--内容头开始-->
            <script>$.include("common/navigation_bar.shtml");</script>
            <!-- 内容头结束-->

            <!-- 内容开始-->

            <div class="container col-sm-12 noneprint" style="padding-bottom:0px">
                <div class="row">
                    <div class="col-sm-3 form-group">
                        <div class="btn-group input-group">
                            <div class="input-group-addon" style="border:0px;">客户号</div>
                            <div id="div_date" class="input-group">
                                <input id="find_customer_code" placeholder="请输入客户号" type="text" class="form-control" name="from">
                                <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-3 form-group">
                        <div class="btn-group input-group input-select2me col-sm-12">
                            <div class="input-group-addon" style="border:0px;">客户类型</div>
                            <select id="find_customer_kind" class="form-control input-middle select2me" data-placeholder="供气区域...">
                                    <option value="">全部</option>
                                <option value="1">居民</option>
                                <option value="9">非居民</option>
                            </select>
                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                        </div>
                    </div>

                    <div class="col-sm-3 form-group">
                        <div class="btn-group input-group input-select2me col-sm-12">
                            <div class="input-group-addon" style="border:0px;">表类型</div>
                            <select id="find_customer_type" class="form-control input-middle select2me" data-placeholder="供气区域...">
                                <option value="">全部</option>
                                <option value="P">普表</option>
                                <option value="I">IC卡</option>
                            </select>
                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                        </div>
                    </div>
                    <div class="col-sm-3 form-group">
                        <div class="btn-group input-group input-select2me col-sm-12">
                            <div class="input-group-addon" style="border:0px;">比较类型</div>
                            <select id="find_compare_type" class="form-control input-middle select2me" data-placeholder="比较类型..">
                                <option value="t">同期</option>
                                <option value="h">环比</option>
                            </select>
                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-3 form-group">
                        <div class="btn-group input-group">
                            <div class="input-group-addon" style="border:0px;">客户名</div>
                            <div id="div_date" class="input-group">
                                <input id="find_customer_name" placeholder="请输入客户名" type="text" class="form-control" name="from">
                                <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-3 form-group">
                        <div class="btn-group input-group input-select2me col-sm-12">
                            <div class="input-group-addon" style="border:0px;">供气区域</div>
                            <select id="find_area_id" class="form-control input-middle select2me" data-placeholder="供气区域...">
                                <option value="">全部</option>
                            </select>
                            <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                        </div>
                    </div>
                    
                    <div class="col-sm-6 form-group">
                        <div class="btn-group input-group">
                            <div class="input-group-addon" style="border:0px;">浮动比例</div>
                            <div class="input-group" data-date-format="yyyy-mm-dd">
                                    <input id="find_rate" placeholder="如:上浮20或下浮输入-20" type="text" class="form-control" name="from">
                                <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                <span class="input-group-addon">%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-3 form-group">
                        <div class="btn-group input-group">
                            <div class="input-group-addon" style="border:0px;">月份</div>
                            <div id="div_date" class="input-group input-daterange" data-date="11/2012" data-date-format="yyyy年mm月">
                                <input id="find_date" type="text" class="form-control" name="from">
                                <span class="inputclear glyphicon glyphicon-remove-circle hidden" ></span>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                            <div class="form-group">
                                <button id="find_sign" type="button" class="btn yellow">
                                    <i class="fa fa-search"></i> 查询 
                                </button>
                                &nbsp;&nbsp;
                                <a id="find_sign" type="button" class="btn green" href="/maintenance/diff_reason.html">
                                    <i class="fa fa-plus"></i> 录入差异原因 
                                </a>                                    
                            </div>
                            
                                    
                        </div>
                </div>
            </div>
            <!-- 内容头结束-->

            <div class="container-fluid">
                <div id="divtable" class="table-responsive col-md-12"></div>
            </div>
            <!-- 内容结束-->
        </div>
    </div>
    <!-- 主内容结束 -->
</div>
<script>$.include("pages/partial/xwatable-form.shtml")</script>
<!-- 底边栏开始 -->
<script>$.include("pages/partial/foot.shtml");</script>
<!-- 底边栏结束 -->
</body>
<script>$.include("pages/partial/scripts.shtml");</script>
<!--跳到原稿-->
<script src="../assets/global/plugins/jquery.cokie.min.js" type="text/javascript"></script>
<script type="text/javascript" src="../assets/global/plugins/jquery-watable/jquery.watable.js"></script>
<script type="text/javascript" src="../pages/scripts/rqlbuilder.js"></script>
<script type="text/javascript" src="../pages/scripts/xwatable.js"></script>
<script type="text/javascript" src="../pages/scripts/refhelper.js"></script>

<!--datapicker start-->
<script type="text/javascript" src="../assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script type="text/javascript"
        src="../assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/clockface/js/clockface.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/moment.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<script src="../assets/admin/pages/scripts/components-pickers.js"></script>

<script type="text/javascript" src="../assets/global/plugins/select2/select2.js"></script>
<script type="text/javascript" src="../assets/global/scripts/bootstrap-monthpicker.js"></script>


<script src="/statement/js/libs/js-xlsx/xlsx.core.min.js" type="text/javascript"></script>
<script src="/statement/js/libs/html2canvas/html2canvas.min.js" type="text/javascript"></script>
<script src="/statement/js/tableExport.js" type="text/javascript"></script>
<script src="/statement/js/datehelper.js" type="text/javascript"></script>

<script type="text/javascript">

    jQuery(document).ready(function () {
        ComponentsPickers.init();
        $('#find_date').bootstrapMonthpicker();
    });

    document.onkeydown = function () {keydown();};
    function keydown() {
        //P 空格 会车 event.keyCode==80 || event.keyCode==32 || event.keyCode==13
        if (event.keyCode == 13) {
            window.print();
        }
    }
    var getRateStyle = function () {
        return {
            f: function (data, row, cell) {
                //cell.closest("tr").addClass("bg-danger");
                return row.rate+"%";
            }
        }
    }();
    $(function () {
        $("#find_date").val(moment().format('YYYY-MM'));
        var areas = new Array();
        var area_id = JSON.parse(localStorage.getItem("user_info")).area_id;
        areas.push(area_id);
        //查询areaId下级areaId
        var queryCondion = RQLBuilder.and([
            RQLBuilder.equal("status", "1"),
            RQLBuilder.equal("parentAreaId", area_id)
        ]).rql()
        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            type: 'get',
            async: false,
            url: hzq_rest + "gasbizarea?query=" + queryCondion,
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    areas.push(data[i].areaId);
                }
            }
        });
        var AreaHelper1 = RefHelper.create({
            ref_url: 'gasbizarea?query={"areaId":{"$in":' + JSON.stringify(areas) + '}}',
            ref_col: "areaId",
            ref_display: "areaName",
            "sort": "posCode"
        });
        gs = AreaHelper1.getRawData();
        gs.forEach(function (val) {
            $('#find_area_id').append('<option value="' + val.areaId + '">' + val.areaName + '</option>');
        })
        
        //查询按钮时间
        $("#find_sign").click(function() {

            $("#btn_down_detail").removeClass("disabled");
            $("#btn_down_detail").removeClass("gray");
            $("#btn_down_detail").addClass("green");

            $("#btn_print_page").removeClass("disabled");
            $("#btn_print_page").removeClass("gray");
            $("#btn_print_page").addClass("green");

            $('#divtabledetailcon').hide();
            
            var where="";
            if(area_id!=1){
                where+=(" and areaId="+area_id);
            }
            var find_area_id = $("#find_area_id").val(),
                find_customer_name = $("#find_customer_name").val(),
                find_customer_code = $("#find_customer_code").val(),
                find_customer_kind = $("#find_customer_kind").val(),
                find_customer_type = $("#find_customer_type").val(),
                find_date = $("#find_date").val(),
                find_compare_type=$("#find_compare_type").val(),
                find_rate = $("#find_rate").val();
            
            if (find_customer_type != "") {
                where += " and e.customerType ='" + find_customer_type + "'"
            }
            if (find_customer_kind != "") {
                if(find_customer_kind!='10'){
                    where += " and e.customerKind ='" + find_customer_kind + "'"
                }                
            }
            
            if(area_id=="1"){
                if (find_area_id != "" && find_area_id != "1") {
                    where += " and e.areaId=" + find_area_id;
                }
            }else{
                where += " and e.areaId=" + area_id;
            }
            
            if (find_customer_name != "") {
                where += " and e.customerName='" + find_customer_name + "'";
            }
            if (find_customer_code != "") {
                where += " and e.customerCode = '" + find_customer_code + "'";
            }
            if (find_rate!= "") {
                if(find_rate>0)where += " and round((e.ysl-e.yslo)/e.merc,4)*100 >= "+find_rate;
                if(find_rate<0)where += " and round((e.ysl-e.yslo)/e.merc,4)*100 <= "+find_rate;
            }
            
            //报表时间是上月26日到当月26日
            var curMonth=find_date.replace('年','-').replace('月','');   
            //月末         
            var end = dateHelper.getMonthEnd(curMonth);
            //月初
            var start = dateHelper.getMonthStart(curMonth);
            //获取当年年初
            var startYear=dateHelper.getCurYearMonthStart(curMonth);
            //当年
            var year=dateHelper.getCurYear(curMonth);
            
            //当月
            var month=parseInt(dateHelper.getCurMonth(curMonth));
            //上年上月 {prevmonth:"",prevyear:""};考虑跨年
            var prev=dateHelper.getPrevMonth(curMonth);
            //上年
            var prevyear=dateHelper.getPrevYear(curMonth);

            var compareYear=0,compareMonth=0,compareName="同期销量";
            //同期
            if(find_compare_type=="t"){
                compareYear=prevyear,compareMonth=month;
            }else if(find_compare_type=="h"){//环比
                compareName="环比销量";
                compareYear=prevyear,compareMonth=month;
            }
            console.log(year,month,compareYear,compareMonth)
            //COUNTPER_ID 核算员 serviceperId=查收员
            $('#divtable').html('');
            var bd =
                { 
                    cols: "e.*,round((e.ysl-e.yslo)/e.merc,4)*100 rate",
                    froms:"(select a.customerCode,a.tel,a.areaId,a.customerAddress,a.customerName,nvl(b.ysl,0) ysl,nvl(c.ysl,0) yslo,a.customerKind,\
                                case when b.ysl=0 or b.ysl is null then 1 else b.ysl end merc,\
                                case when a.customerType='I' then 'IC卡' else '普表' end customerType,cu.employeeName countperUserName,\
                                su.employeeName serviceperUserName,p.factoryName,q.flowName,mo.cmCause \
                        from gasCtmArchive a \
                            left join (\
                                select sum(gas) ysl,customerCode from gasReportYslNew \
                                where reportYear="+year+" and reportMonth="+month+" \
                                group by customerCode \
                            ) b on a.customerCode=b.customerCode\
                            left join (\
                                select sum(gas) ysl,customerCode from gasReportYslNew \
                                where reportYear="+compareYear+" and reportMonth="+compareMonth+" \
                                group by customerCode \
                            ) c on a.customerCode=c.customerCode \
                            left join gasCtmMeter n on n.ctmArchiveId=a.ctmArchiveId \
                            left join gasMtrMeter m on n.meterId=m.meterId \
                            left join gasMtrMeterFlow q on q.meterFlowId=m.flow \
                            left join gasMtrFactory p on p.factoryId=m.factoryId\
                            left join gasMrdBook d on d.bookId=a.bookId \
                            left join gasSysUser cu on cu.userId=d.countperId \
                            left join gasSysUser su on su.userId=d.serviceperId \
                            left join gasCtmCompareMonth mo on a.customerCode=mo.customerCode and \
                            mo.reportYear="+year+" and mo.reportMonth="+month+" and mo.cmType='"+find_compare_type+"') e",
                    wheres: "1=1 " + where+ " order by e.ysl desc",
                    page:true,
                };
            
            xw = XWATable.init({
                divname: "divtable",
                //----------------table的选项-------
                pageSize: 10, 			//Initial pagesize
                columnPicker: true,         //Show the columnPicker button
                sorting: true,
                transition: 'fade',  //(bounce, fade, flip, rotate, scroll, slide).
                checkboxes: false,           //Make rows checkable. (Note. You need a column with the 'unique' property)
                checkAllToggle: true,        //Show the check-all toggle//+RQLBuilder.like("KEYY", "a").rql()
                restURL: 'hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&bd=' + encodeURIComponent(JSON.stringify(bd)),
                key_column: 'customerCode',
                coldefs: [
                    {
                        col: "customerCode",
                        friendly: "客户号",
                        unique: true,
                        sorting: false,
                        index: 1
                    },
                    {
                        col: "customerName",
                        friendly: "客户名",
                        sorting: false,
                        index: 2
                    },
                    {
                        col: "customerAddress",
                        friendly: "客户地址",
                        sorting: false,
                        index: 3
                    },
                    {
                        col: "customerType",
                        friendly: "表类型",
                        sorting: false,
                        index: 4
                    },
                    {
                        col: "tel",
                        friendly: "联系电话",
                        sorting: false,
                        index: 5
                    },
                    {
                        col: "ysl",
                        friendly: "当月销量",
                        className:"bg-success",
                        sorting: false,
                        index: 6
                    },
                    {
                        col: "yslo",
                        friendly: compareName,
                        className:"bg-warning",
                        sorting: false,
                        index: 7
                    },
                    {
                        col: "rate",
                        friendly: "浮动比例",
                        sorting: false,
                        className:"bg-default",
                        format:getRateStyle,
                        index: 8
                    },{
                        col: "cmCause",
                        friendly: "差异原因",
                        className:"bg-danger",
                        sorting: false,
                        index: 9
                    },
                    {
                        col: "countperUserName",
                        friendly: "核算员",
                        sorting: false,
                        index: 10
                    },
                    {
                        col: "serviceperUserName",
                        friendly: "查收员",
                        sorting: false,
                        index: 11
                    },
                    {
                        col: "factoryName",
                        friendly: "表厂家",
                        sorting: false,
                        index: 12
                    },
                    {
                        col: "flowName",
                        friendly: "表流量",
                        sorting: false,
                        index: 13
                    }

                ],
            });
        });
    });
</script><!-- End of User Script-->
</html>