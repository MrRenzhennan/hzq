<!DOCTYPE html>
<!--[if IE 8]>
<html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!-->
<html lang="zh">
<!--<![endif]-->

<!-- BEGIN HEAD -->

<head>
    <title>代征城镇垃圾处理费月度统计</title>
    <script src="../pages/scripts/basepath.js"></script>
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-select/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/select2/select2.css">
    <script src="../pages/scripts/header.js"></script>
    <meta http-equiv="content-type" content="text/html" charset="utf-8" />
    <link href='../assets/global/plugins/jquery-watable/watable.css' rel='stylesheet' />
    <link href='../assets/global/plugins/jquery-watable/animate.min.css' rel='stylesheet' />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.css"
    />
    <link href='../assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css' rel='stylesheet' />

    <!--datapicker css start-->
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-datepicker/css/datepicker3.css" />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css"
    />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-colorpicker/css/colorpicker.css" />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-daterangepicker/daterangepicker-bs3.css"
    />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css" />
    <!--datapicker end-->

    <link rel="stylesheet" href="/statement/css/3.3.7/bootstrap.min.css">
    <link href='../assets/global/css/bootstrap-monthpicker.css' rel='stylesheet'/>
    <!-- END THEME STYLES -->
    <style>
        @media print {
            .noneprint {
                display: none;
            }
        }

        .tabPrint td {
            border-left: #000000 solid 1px;
            border-top: #000000 solid 1px;
            height: 21px;
        }

        table.tabPrint {
            border-right: #000000 solid 1px;
            border-bottom: #000000 solid 1px;
        }

        .nextPage {
            page-break-after: always;
        }

        .linetd {
            border-bottom: solid 1px #000;
        }
    </style>
</head>
<!-- END HEAD -->

<body class="page-header-fixed page-quick-sidebar-over-content">

    <!-- 标题栏开始 -->
    <div class="page-header navbar navbar-fixed-top">
        <script>
            $.include("pages/partial/menu.shtml");
        </script>
    </div>
    <!-- 标题栏结束 -->
    <div class="clearfix"></div>
    <div class="page-container">
        <!-- 左侧菜单开始 -->
        <div class="page-sidebar-wrapper">
            <script>
                $.include("pages/partial/sidebar.shtml");
            </script>
        </div>
        <!-- 左侧菜单结束 -->

        <!-- 主内容开始 -->
        <div class="page-content-wrapper">
            <div class="page-content">
                <!--内容头开始-->
                <!--内容头开始-->
                <div class="row noneprint">
                    <div class="col-md-12">
                        <ul class="page-breadcrumb breadcrumb">
                            <li>
                                <i class="fa fa-map-marker"></i>
                                <a href="index.html">报表统计</a>
                                <i class="fa fa-angle-right"></i>
                            </li>
                            <li>
                                <a href="javascript:void(0)">代征城镇垃圾处理费月度统计</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <!-- 内容头结束-->

                <!-- 内容开始-->

                <div class="container col-sm-12 noneprint" style="padding-bottom:0px">
                    <div class="row">

                        <div class="col-sm-3 form-group">
                            <div class="btn-group input-group">
                                <div class="input-group-addon" style="border:0px;">日期：</div>
                                <div id="div_date" class="input-group input-daterange" data-date="11/2012" data-date-format="yyyy-mm">
                                    <input id="find_date" type="text" class="form-control" name="from">
                                    <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3 form-group">
                        </div>
                        <div class="col-sm-3 form-group">
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <button id="find_sign" type="button" class="btn yellow">
                                查询 <i class="fa fa-search"></i>
                            </button> &nbsp;&nbsp;&nbsp;&nbsp;
                                <button id="btn_print_page" onclick="window.print()" type="button" class="btn gray disabled">
                                打印<i class="glyphicon"></i>
                            </button> &nbsp;&nbsp;&nbsp;&nbsp;
                                <button id="btn_down_detail" type="button" class="btn gray disabled export-excel">
                                导出<i class="glyphicon"></i>
                            </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 内容头结束-->

                <div class="container-fluid">
                    <div>
                        <table cellSpacing="0" cellPadding="2" width="98%" align="center" border="0">
                            <tr>
                                <td id="title" align="center" title="">代征城镇垃圾处理费月度统计</td>
                            </tr>
                        </table>
                    </div>
                    <br/>
                    <table class="tabPrint table-bordered table-hover table-condensed " align="center" width="98%" cellSpacing="0" cellPadding="0"
                        border="0" ID="Table2">
                        <thead style="display:table-header-group;font-weight:bold" mce_style="display:table-header-group;font-weight:bold">
                            <tr align="center">
                                <td id="thead_r1_c1" rowspan="1" colspan="1"></td>
                                <td id="thead_r1_c2" rowspan="1" colspan="1">收费单位</td>
                                <td id="thead_r1_c3" rowspan="1" colspan="1">本月代收垃圾费金额</td>
                                <td id="thead_r1_c4" rowspan="1" colspan="1">本月代收垃圾费笔数</td>
                                <td id="thead_r1_c6" rowspan="1" colspan="1">费率</td>
                                <td id="thead_r1_c5" rowspan="1" colspan="1">手续费</td>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                        </tbody>
                    </table>
                    <br/><br/></div>
                <!-- 内容结束-->
            </div>
        </div>
        <!-- 主内容结束 -->
    </div>

    <!-- 底边栏开始 -->
    <script>
                $.include("pages/partial/foot.shtml");
    </script>
    <!-- 底边栏结束 -->
</body>


<script>
        $.include("pages/partial/scripts.shtml");

</script>
<!--跳到原稿-->
<script src="../assets/global/plugins/jquery.cokie.min.js" type="text/javascript"></script>
<script type="text/javascript" src="../assets/global/plugins/jquery-watable/jquery.watable.js"></script>
<script type="text/javascript" src="../pages/scripts/rqlbuilder.js"></script>
<script type="text/javascript" src="../pages/scripts/xwatable.js"></script>
<script type="text/javascript" src="../pages/scripts/refhelper.js"></script>

<!--datapicker start-->
<script type="text/javascript" src="../assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/clockface/js/clockface.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/moment.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<script src="../assets/admin/pages/scripts/components-pickers.js"></script>

<script type="text/javascript" src="../assets/global/plugins/select2/select2.js"></script>
<script type="text/javascript" src="../assets/global/scripts/bootstrap-monthpicker.js"></script>


<script src="/statement/js/libs/js-xlsx/xlsx.core.min.js" type="text/javascript"></script>
<script src="/statement/js/libs/html2canvas/html2canvas.min.js" type="text/javascript"></script>
<script src="/statement/js/tableExport.js" type="text/javascript"></script>

<script type="text/javascript">
    $(".export-excel").attr("data-table", ".tabPrint");
    //    $(".export-excel").attr("data-filename","");
    $(".export-excel").on("click", function (e) {
        e.preventDefault();
        var exportTable = $(this).data("table");
        var filename = $("#title").html();//$(this).data("filename");
        var ignoreColumn = "";//$(this).data("ignorecolumn");
        $(exportTable).tableExport({
            fileName: filename,
            type: 'excel',
            escape: 'false',
            excelstyles: ['border-bottom', 'border-top', 'border-left', 'border-right'],
            ignoreColumn: '[' + ignoreColumn + ']'
        });
    });

    jQuery(document).ready(function () {
        ComponentsPickers.init();
        $('#find_date').bootstrapMonthpicker();
        // ComponentsDropdowns.init();
    });

    document.onkeydown = function () { keydown(); };
    function keydown() {
        //P 空格 会车 event.keyCode==80 || event.keyCode==32 || event.keyCode==13
        if (event.keyCode == 13) {
            window.print();
        }
    }

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return decodeURIComponent(r[2]);
        return null;
    }

    function toAmount(amount) {
        var numArray = amount.toString().split(".");

        if (numArray.length > 1) {
            console.log("##amount=" + amount + "##" + amount.toString().split(".").length + "##" + numArray[1].length);
            if (numArray[1].length < 2) {
                amount = amount + "0";
            } else if (numArray[1].length > 2) {
                amount = numArray[0] + "." + numArray[1].substring(0, 2);
            }
        } else {
            amount = amount + ".00";
        }
        //return (amount * 1);//字符串变数字
        return amount;
    }

    function date_format(date, fmt) {
        var dataJson = {
            "M+": date.getMonth() + 1, //月份
            "d+": date.getDate(), //日
            "h+": date.getHours(), //小时
            "m+": date.getMinutes(), //分
            "s+": date.getSeconds(), //秒
            "q+": Math.floor((date.getMonth() + 3) / 3), //季度
            "S": date.getMilliseconds() //毫秒
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in dataJson)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (dataJson[k]) : (("00" + dataJson[k]).substr(("" + dataJson[k]).length)));
        return fmt;
    }

    function edit(id) {
        var v = $("#" + id).html();
        $("#" + id).html("<input type='number' id='" + id + "_text' oldid='" + id + "' oldvalue='" + v + "' value='" + v + "' onblur='outEdit(this.id)'/>");
        $("#" + id + "_text").focus();
    }
    function outEdit(id) {
        var ov = $("#" + id).attr("oldvalue");
        var oid = $("#" + id).attr("oldid");
        $("#" + oid).html($("#" + id).val());
    }

    function operationData(operationDataJson) {
        for (var i = 0; i < operationDataJson.length; i++) {
            var inputCols = operationDataJson[i].ic;
            var operator = operationDataJson[i].op;
            var out = $("#tbody_" + inputCols[0]).html() * 1;
            for (var j = 1; j < inputCols.length; j++) {
                var value = $("#tbody_" + inputCols[j]).html() * 1;
                if (operator == "+") {
                    out = out + value;
                }
            }
            var outputColType = operationDataJson[i].ty;
            var outputCol = operationDataJson[i].oc;
            if (outputColType && outputColType == "f") {
                $("#tbody_" + outputCol).html(toAmount(out + ""));
            } else {
                $("#tbody_" + outputCol).html(out);
            }

        }
    }

    function toZero(num){
        return num;
        if(!num)return "<font style='color:#eee'>0</font>";
        else if(num=="0.00" || num=="0.0000"){
            return "<font style='color:#eee'>"+num+"</font>"
        }else{
            return num;
        }   
    }
    function getMoeny(data,areaid){
        var num=0;
        if(data){
            data.forEach(function(o){
                //获取营业公司的
                if(o.areaId){  
                    if(o.areaId==areaid){ 
                        num+=o.ctmNum;
                    }
                }                
            });
        }
        
        return num;
    }
    function getBankMoeny(data,chargeUnitCode){
        var num=0;
        if(data){
            data.forEach(function(o){

                //获取银行的
                if(o.areaId==1){  
                    if(o.chargeUnitCode==chargeUnitCode){ 
                        num+=o.ctmNum;
                    }
                }
                
            });
        }
        
        return num;
    }

    $(function () {
        $("#find_date").val(date_format(new Date(), "yyyy-MM"));
        $("#title").html($("#find_date").val() + "&nbsp;&nbsp;代征城镇垃圾处理费月度统计");

        var gsRateDate = Restful.find(hzq_rest + 'gassysparameter', JSON.stringify({ "parameterCode": "wastefee.rate" }));
        var gsRate=0.07;
        if(gsRateDate){
            gsRateDate.forEach(function(o){
                if(o.parameterCode=="wastefee.rate"){
                    gsRate=o.parameterValue;
                }
            })
        }
        var cat=[{name:'中庆燃气',id:1},{name:'银行代收',id:2}];
        var areas = new Array();
        var area_id = JSON.parse(localStorage.getItem("user_info")).area_id;
        areas.push(area_id);
        //查询areaId下级areaId
        var queryCondion = RQLBuilder.and([
            RQLBuilder.equal("status", "1"),
            RQLBuilder.equal("parentAreaId", area_id)
        ]).rql()
        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            type: 'get',
            async: false,
            url: hzq_rest + "gasbizarea?query=" + queryCondion,
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    areas.push(data[i].areaId);
                }
            }
        });
        var AreaHelper1 = RefHelper.create({
            ref_url: 'gasbizarea?query={"areaId":{"$in":' + JSON.stringify(areas) + '}}',
            ref_col: "areaId",
            ref_display: "areaName",
            "sort": "posCode"
        });
        var gsData = AreaHelper1.getRawData();

        var blData=Restful.find(hzq_rest+'gasbasbank',JSON.stringify({ "status": "1" }));
        var bl=[],gs=[];
        blData.forEach(function(o){
            if(o.bankId!='11' && o.bankId!='12'){
                bl.push(o);
            }
        })
        gsData.forEach(function(o){
            if(o.areaId!='23' && o.areaId!='18' && o.areaId!='11' && o.areaId!='21' && o.areaId!='1'){
                gs.push(o);
            }
        })
        var tbody = "";
        for (var i = 0; i < gs.length; i++) {
            
            if(i==0){
                tbody = tbody + '<tr align="center" data-catid="'+cat[0].id+'" data-areaid="'+gs[i].areaId+'">' +
                    '<td id="tbody_r' + cat[0].id+"_"+gs[i].areaId + '_d1" rowspan="'+(gs.length+1)+'" colspan="1">' + cat[0].name + '</td>' +
                    '<td id="tbody_r' + cat[0].id+"_"+gs[i].areaId + '_d2" rowspan="1" colspan="1">'+gs[i].areaName+'</td>' +
                    '<td id="tbody_r' + cat[0].id+"_"+gs[i].areaId + '_d3" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[0].id+"_"+gs[i].areaId + '_d4" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[0].id+"_"+gs[i].areaId + '_d6" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[0].id+"_"+gs[i].areaId + '_d5" rowspan="1" colspan="1">0</td>' +
                    '</tr>';
            }else{
                tbody = tbody + '<tr align="center" data-catid="'+cat[0].id+'" data-areaid="'+gs[i].areaId+'">' +
                    '<td id="tbody_r' + cat[0].id+"_"+gs[i].areaId + '_d2" rowspan="1" colspan="1">'+gs[i].areaName+'</td>' +
                    '<td id="tbody_r' + cat[0].id+"_"+gs[i].areaId + '_d3" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[0].id+"_"+gs[i].areaId + '_d4" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[0].id+"_"+gs[i].areaId + '_d6" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[0].id+"_"+gs[i].areaId + '_d5" rowspan="1" colspan="1">0</td>' +
                    '</tr>';
            }
        }
        tbody = tbody + '<tr align="center" data-catid="'+cat[0].id+'" data-areaid="0" data-chargerate="0" style="background-color:#eee">' +
                    '<td id="tbody_r' + cat[0].id+'_d2" rowspan="1" colspan="1">小计</td>' +
                    '<td id="tbody_r' + cat[0].id+'_d3" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[0].id+'_d4" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[0].id+'_d6" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[0].id+'_d5" rowspan="1" colspan="1">0</td>' +
                    '</tr>';
        for (var i = 0; i < bl.length; i++) {
            if(i==0){
                tbody = tbody + '<tr align="center" data-catid="'+cat[1].id+'" data-bankcode="'+bl[i].bankCode+'" data-chargerate="'+bl[i].chargeRate+'">' +
                    '<td id="tbody_r' + cat[1].id+"_"+bl[i].bankCode + '_d1" rowspan="'+bl.length+1+'" colspan="1">' + cat[1].name + '</td>' +
                    '<td id="tbody_r' + cat[1].id+"_"+bl[i].bankCode + '_d2" rowspan="1" colspan="1">'+bl[i].bankName+'</td>' +
                    '<td id="tbody_r' + cat[1].id+"_"+bl[i].bankCode + '_d3" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[1].id+"_"+bl[i].bankCode + '_d4" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[1].id+"_"+bl[i].bankCode + '_d6" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[1].id+"_"+bl[i].bankCode + '_d5" rowspan="1" colspan="1">0</td>' +
                    '</tr>';
            }else{
                tbody = tbody + '<tr align="center" data-catid="'+cat[1].id+'" data-bankcode="'+bl[i].bankCode+'" data-chargerate="'+bl[i].chargeRate+'">' +
                    '<td id="tbody_r' + cat[1].id+"_"+bl[i].bankCode + '_d2" rowspan="1" colspan="1">'+bl[i].bankName+'</td>' +
                    '<td id="tbody_r' + cat[1].id+"_"+bl[i].bankCode + '_d3" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[1].id+"_"+bl[i].bankCode + '_d4" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[1].id+"_"+bl[i].bankCode + '_d6" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[1].id+"_"+bl[i].bankCode + '_d5" rowspan="1" colspan="1">0</td>' +
                    '</tr>';
            }
            
        }
        tbody = tbody + '<tr align="center"  data-catid="'+cat[1].id+'" data-bankcode="0" data-chargerate="0" style="background-color:#eee">' +
                    '<td id="tbody_r' + cat[1].id+'_d2" rowspan="1" colspan="1">小计</td>' +
                    '<td id="tbody_r' + cat[1].id+'_d3" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[1].id+'_d4" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[1].id+'_d6" rowspan="1" colspan="1">0</td>' +
                    '<td id="tbody_r' + cat[1].id+'_d5" rowspan="1" colspan="1">0</td>' +
                    '</tr>';
        
        $("#tbody").html(tbody);

        //查询按钮时间
        $("#find_sign").click(function () {
            if ($("#find_date").val() == "") {
                bootbox.alert("请您选择要查询的月份！");
                return;
            }
            $("#title").html($("#find_date").val() + "&nbsp;&nbsp;本月垃圾费金额");

            var userInfo = JSON.parse(localStorage.getItem("user_info"));
            if (userInfo.employee_name) {
                $("#foot_r0_c8").html(userInfo.employee_name);
            } else {
                $("#foot_r0_c8").html("管理员");
            }
            $("#foot_r0_c15").html(date_format(new Date(), "yyyy-MM-dd"));

            $("#btn_down_detail").removeClass("disabled");
            $("#btn_down_detail").removeClass("gray");
            $("#btn_down_detail").addClass("green");

            $("#btn_print_page").removeClass("disabled");
            $("#btn_print_page").removeClass("gray");
            $("#btn_print_page").addClass("green");


            var start = $("#find_date").val()+"-01";
            var end = moment(start).add('month', 1).format("YYYY-MM-DD");
            var $tbody = $("#tbody");
            var whereClause3 = "c.dt>=to_date('" + start + "','yyyy-MM-dd') and c.dt<to_date('" + end + "','yyyy-MM-dd') and c.tradeType in ('CHG','RFD','COR') and c.money is not null";
            //获取本月代收垃圾处理费金额
            $.ajax({
                url: "hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd",
                type: "POST",
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify({
                    cols: "sum(c.money) ctmNum,d.areaId,d.chargeUnitCode",
                    froms: "(select a.*,nvl(to_date(b.bankDate,'yyyy-MM-dd hh:mi:ss'),a.trade_date) dt \
                            from gasActWastefeeAtl a left join gasChgWasteBankFace b on a.wastefeeAtlId=b.tradeAtlId\
                            where b.bankCode is null) c \
                            inner join gasBizChargeUnit d on c.chargeUnitId=d.chargeUnitId ",
                    wheres: whereClause3+" group by d.areaId,d.chargeUnitCode",
                    page: "false"
                }),
                dataType: "json",
                success: function (data) {
                    console.log("data",data);
                    var numTotal=0.00,numBankTotal=0.00,numBankRateTotal=0.00,numRateTotal=0.00;
                    $("#tbody").find("tr").each(function(){
                        var areaId=$(this).data("areaid");
                        var bankCode=$(this).data("bankcode");
                        var catid=$(this).data("catid");
                        var chargeRate=$(this).data("chargerate");
                        //绑定公司
                        if(areaId){
                            var num=getMoeny(data.rows,areaId);
                            numTotal+=num;
                            $(this).find("#tbody_r" + cat[0].id+ "_" + areaId + "_d3").html(toZero(num.toFixed(2)));                            
                            $(this).find("#tbody_r" + cat[0].id+ "_" + areaId + "_d6").html(gsRate);

                            var numRate=(num*gsRate).toFixed(4);
                            numRateTotal+=parseFloat(numRate);
                            $(this).find("#tbody_r" + cat[0].id+ "_" + areaId + "_d5").html(toZero(numRate));
                        }else{
                            //计算小计手续费
                            $(this).find("#tbody_r" + cat[0].id + "_d3").html(toZero(numTotal.toFixed(2)));
                            $(this).find("#tbody_r" + cat[0].id + "_d5").html(toZero(numRateTotal.toFixed(4)));
                            $(this).find("#tbody_r" + cat[0].id+  "_d6").html('-');
                        }
                    })                    
                }
            });
            //获取银行代征垃圾费
            var whereClause_face_3 = "c.bankCode is not null and dt >= to_date('" + start + "','yyyy-MM-dd') \
                        and dt<to_date('" + end + "','yyyy-MM-dd') and c.tradeType in ('CHG','RFD','COR') and c.money is not null";
            $.ajax({
                url: "hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd",
                type: "POST",
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify({
                    cols: "sum(c.money) ctmNum,c.bankCode chargeUnitCode,1 areaId",
                    froms: "(select a.*,nvl(to_date(b.bankDate,'yyyy-MM-dd hh:mi:ss'),a.trade_date) dt,b.bankCode \
                            from gasActWastefeeAtl a \
                                left join gasChgWasteBankFace b on a.wastefeeAtlId=b.tradeAtlId) c",
                    wheres: whereClause_face_3+" group by c.bankCode",
                    page: "false"
                }),
                dataType: "json",
                success: function (data) {
                    console.log("data",data);
                    var numTotal=0.00,numBankTotal=0.00,numBankRateTotal=0.00,numRateTotal=0.00;
                    $("#tbody").find("tr").each(function(){
                        var areaId=$(this).data("areaid");
                        var bankCode=$(this).data("bankcode");
                        var catid=$(this).data("catid");
                        var chargeRate=$(this).data("chargerate");
                        //绑定银行
                        if(bankCode){
                            var num=getBankMoeny(data.rows,bankCode);
                            if(num)numBankTotal+=num;
                            $(this).find("#tbody_r" + cat[1].id+ "_" + bankCode + "_d3").html(toZero(num.toFixed(2)));
                            $(this).find("#tbody_r" + cat[1].id+ "_" + bankCode + "_d6").html(chargeRate);
                            if(chargeRate){
                                var numRate=(num*chargeRate).toFixed(4);
                                numBankRateTotal+=parseFloat(numRate)
                                $(this).find("#tbody_r" + cat[1].id+ "_" + bankCode + "_d5").html(toZero(numRate));                                
                            }
                        }else{
                            $(this).find("#tbody_r" + cat[1].id + "_d3").html(toZero(numBankTotal.toFixed(2)));
                            $(this).find("#tbody_r" + cat[1].id + "_d6").html('-');
                            $(this).find("#tbody_r" + cat[1].id + "_d5").html(numBankRateTotal.toFixed(4));
                        }
                    })                    
                }
            });
            //获取供气区域本月代收垃圾费笔数
            var whereClause4 = "a.tradeDate >= to_date('" + start + "','yyyy-MM-dd') \
                        and a.tradeDate<to_date('" + end + "','yyyy-MM-dd') and a.tradeType in ('CHG') and a.money is not null";
            $.ajax({
                url: "hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd",
                type: "POST",
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify({
                    cols: "count(1) ctmNum,b.areaId,b.chargeUnitCode",
                    froms: "gasActWastefeeAtl a inner join gasBizChargeUnit b on a.chargeUnitId=b.chargeUnitId",
                    wheres: whereClause4+" group by b.areaId,b.chargeUnitCode",
                    page: "false"
                }),
                dataType: "json",
                success: function (data) {
                    
                    var numTotal=0,numBankTotal=0;
                    $("#tbody").find("tr").each(function(){
                        var areaId=$(this).data("areaid");
                        var bankCode=$(this).data("bankcode");
                        var catid=$(this).data("catid");
                        var chargeRate=$(this).data("chargerate");
                        //绑定公司
                        if(areaId){
                            var num=getMoeny(data.rows,areaId);
                            numTotal+=num;
                            $(this).find("#tbody_r" + cat[0].id+ "_" + areaId + "_d4").html(toZero(num)); 
                        }else{
                            //计算小计手续费
                            $(this).find("#tbody_r" + cat[0].id + "_d4").html(toZero(numTotal));
                        }                                           
                    })

                }
            });
            //获取银行收费笔数
            var whereClause_face_4 = "to_date(tradeDate,'yyyy-MM-dd') between to_date('" + start + "','yyyy-MM-dd') \
                        and to_date('" + end + "','yyyy-MM-dd')";
            $.ajax({
                url: "hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd",
                type: "POST",
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify({
                    cols: "count(1) ctmNum,bankCode chargeUnitCode ,1 areaId",
                    froms: "gasChgWasteBalanceDetail",
                    wheres: whereClause_face_4+" group by bankCode",
                    page: "false"
                }),
                dataType: "json",
                success: function (data) {
                    
                    var numTotal=0,numBankTotal=0;
                    $("#tbody").find("tr").each(function(){
                        var areaId=$(this).data("areaid");
                        var bankCode=$(this).data("bankcode");
                        var catid=$(this).data("catid");
                        var chargeRate=$(this).data("chargerate");
                        //绑定银行
                        if(bankCode){
                            var num=getBankMoeny(data.rows,bankCode);
                            numBankTotal+=num;
                            $(this).find("#tbody_r" + cat[1].id+ "_" + bankCode + "_d4").html(toZero(num));
                        }else{
                            $(this).find("#tbody_r" + cat[1].id + "_d4").html(numBankTotal);
                        }                                             
                    })
                }
            });
        });
    });

</script>
<!-- End of User Script-->

</html>