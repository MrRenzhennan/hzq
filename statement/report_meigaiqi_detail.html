<!DOCTYPE html>
<!--[if IE 8]>
<html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!-->
<html lang="zh">
<!--<![endif]-->

<!-- BEGIN HEAD -->

<head>
    <title>煤改气销售查询</title>
    <script src="../pages/scripts/basepath.js"></script>
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-select/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/select2/select2.css">
    <script src="../pages/scripts/header.js"></script>
    <meta http-equiv="content-type" content="text/html" charset="utf-8" />
    <link href='../assets/global/plugins/jquery-watable/watable.css' rel='stylesheet' />
    <link href='../assets/global/plugins/jquery-watable/animate.min.css' rel='stylesheet' />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.css"
    />
    <link href='../assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css' rel='stylesheet' />

    <!--datapicker css start-->
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-datepicker/css/datepicker3.css" />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css"
    />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-colorpicker/css/colorpicker.css" />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-daterangepicker/daterangepicker-bs3.css"
    />
    <link rel="stylesheet" type="text/css" href="../assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css" />
    <!--datapicker end-->

    <link rel="stylesheet" href="/statement/css/3.3.7/bootstrap.min.css">
    <link href='../assets/global/css/bootstrap-monthpicker.css' rel='stylesheet'/>
    <!-- END THEME STYLES -->
    <style>
        @media print {
            .noneprint {
                display: none;
            }
        }
        .tabPrint td {
            border-left: #000000 solid 1px;
            border-top: #000000 solid 1px;
            height: 21px;
        }

        table.tabPrint {
            border-right: #000000 solid 1px;
            border-bottom: #000000 solid 1px;
        }

        .nextPage {
            page-break-after: always;
        }

        .linetd {
            border-bottom: solid 1px #000;
        }
    </style>
</head>
<!-- END HEAD -->

<body class="page-header-fixed page-quick-sidebar-over-content">

    <!-- 标题栏开始 -->
    <div class="page-header navbar navbar-fixed-top">
        <script>
            $.include("pages/partial/menu.shtml");
        </script>
    </div>
    <!-- 标题栏结束 -->
    <div class="clearfix"></div>
    <div class="page-container">
        <!-- 左侧菜单开始 -->
        <div class="page-sidebar-wrapper">
            <script>
                $.include("pages/partial/sidebar.shtml");
            </script>
        </div>
        <!-- 左侧菜单结束 -->

        <!-- 主内容开始 -->
        <div class="page-content-wrapper">
            <div class="page-content">
                <!--内容头开始-->
                <!--内容头开始-->
                <script>$.include("common/navigation_bar.shtml");</script>
                <!-- 内容头结束-->

                <!-- 内容开始-->

                <div class="container col-sm-12 noneprint" style="padding-bottom:0px">
                    <div class="row">
                        <div class="col-sm-3 form-group">
                            <div class="btn-group input-group">
                                <div class="input-group-addon" style="border:0px;">客户号</div>
                                <div id="div_date" class="input-group">
                                    <input id="find_customer_code" placeholder="请输入客户号" type="text" class="form-control" name="from">
                                    <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3 form-group">
                            <div class="btn-group input-group input-select2me col-sm-12">
                                <div class="input-group-addon" style="border:0px;">用气性质</div>
                                <select id="find_gas_type_id" class="form-control input-middle select2me" data-placeholder="供气区域...">
                                    <option value="">全部</option>
                                </select>
                                <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                            </div>
                        </div>

                        <div class="col-sm-3 form-group">
                            <div class="btn-group input-group input-select2me col-sm-12">
                                <div class="input-group-addon" style="border:0px;">表流量</div>
                                <input id="find_rating_flux_min" type="text" class="inputclear form-control" name="from">
                                <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                <span class="input-group-addon">~</span>
                                <input id="find_rating_flux_max" type="text" class="inputclear form-control" name="to">
                                <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <button id="find_sign" type="button" class="btn yellow">
                                查询 <i class="fa fa-search"></i>
                            </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3 form-group">
                            <div class="btn-group input-group input-select2me col-sm-12">
                                <div class="input-group-addon" style="border:0px;">供气单位</div>
                                <select id="find_area_id" class="form-control input-middle select2me" data-placeholder="供气区域...">
                                    <option value="">全部</option>
                                </select>
                                <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                            </div>
                        </div>

                        <div class="col-sm-3 form-group">
                            <div class="btn-group input-group">
                                <div class="input-group-addon" style="border:0px;">客户名</div>
                                <div id="div_date" class="input-group">
                                    <input id="find_customer_name" placeholder="请输入客户名" type="text" class="form-control" name="from">
                                    <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 form-group">
                            <div class="btn-group input-group pull-left">
                                <div class="input-group-addon" style="border:0px;">用气日期</div>
                                <div class="input-group input-large date-picker input-daterange" data-date-format="yyyy-mm-dd">
                                    <input id="find_start_trade_date" type="text" class="form-control" readonly>
                                    <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                    <span class="input-group-addon">至</span>
                                    <input id="find_end_trade_date" type="text" class="form-control" readonly>
                                    <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">

                        <div class="col-sm-3 form-group">
                            <div class="btn-group input-group input-select2me col-sm-12">
                                <div class="input-group-addon" style="border:0px;">交易类型</div>
                                <select id="find_trade_type" class="form-control input-middle select2me" data-placeholder="供气区域...">
                                    <option value="">全部</option>
                                    <option value="BLL">计费</option>
                                    <option value="CHG">收费</option>
                                    <option value="COR">冲正</option>
                                    <option value="RFD">退款</option>
                                    <option value="ICR">写卡</option>
                                    <option value="ICB">扣划</option>
                                </select>
                                <span class="inputclear glyphicon glyphicon-remove-circle hide"></span>
                            </div>
                        </div>
                        <div class="col-sm-6 form-group">
                            <div class="btn-group input-group pull-left">
                                <div class="input-group-addon" style="border:0px;">开栓日期</div>
                                <div class="input-group input-large date-picker input-daterange" data-date-format="yyyy-mm-dd">
                                    <input id="find_start_unbolt_time" type="text" class="form-control" readonly>
                                    <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                    <span class="input-group-addon">至</span>
                                    <input id="find_end_unbolt_time" type="text" class="form-control" readonly>
                                    <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 内容头结束-->

                <div class="container-fluid">
                    <div class="container-fluid">
                        <div id="divtable" class="table-responsive col-md-12">
                        </div>
                    </div>
                    <br/>
                    <br/><br/></div>
                <!-- 内容结束-->
            </div>
        </div>
        <!-- 主内容结束 -->
    </div>

    <script type="text/javascript">
        $.include("pages/partial/xwatable-form.shtml")
    </script>
    <!-- 底边栏开始 -->
    <script>
                $.include("pages/partial/foot.shtml");
    </script>
    <!-- 底边栏结束 -->
</body>


<script>
        $.include("pages/partial/scripts.shtml");

</script>
<!--跳到原稿-->
<script src="../assets/global/plugins/jquery.cokie.min.js" type="text/javascript"></script>
<script type="text/javascript" src="../assets/global/plugins/jquery-watable/jquery.watable.js"></script>
<script type="text/javascript" src="../pages/scripts/rqlbuilder.js"></script>
<script type="text/javascript" src="../pages/scripts/xwatable.js"></script>
<script type="text/javascript" src="../pages/scripts/refhelper.js"></script>

<!--datapicker start-->
<script type="text/javascript" src="../assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/clockface/js/clockface.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/moment.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<script src="../assets/admin/pages/scripts/components-pickers.js"></script>

<script type="text/javascript" src="../assets/global/plugins/select2/select2.js"></script>
<script type="text/javascript" src="../assets/global/scripts/bootstrap-monthpicker.js"></script>


<script src="/statement/js/libs/js-xlsx/xlsx.core.min.js" type="text/javascript"></script>
<script src="/statement/js/libs/html2canvas/html2canvas.min.js" type="text/javascript"></script>
<script src="/statement/js/tableExport.js" type="text/javascript"></script>
<script src="/statement/js/datehelper.js" type="text/javascript"></script>

<script type="text/javascript">
    var tradeTypeDesc = { "ZBBLL": "追补", "BLLCORRECT": "计费更正", "ZHYEJZ": "账户余额结转", "ICVBFKH": "IC卡月出账部分扣划",
        "ICVKHERROR": "IC卡月出账扣划失败", "ICVZZKH": "IC卡月出账足额扣划", "ICBANKCOR": "IC卡银行冲正",
        "LHZHZZHKF": "联合账户子账户扣费", "LHZHKH": "联合账户划款", "CHGMONEYERRORCOR": "收费金额变更冲正",
        "CHGMONEYERROR": "收费金额变更", "ICCOR": "IC卡收费冲正", "ICCORICR": "IC卡写卡冲正", "CCHG": "串户收费",
        "RCHG": "串户扣费", "ICCHG": "收费金额", "ICBANKCHG": "银行缴费", "ICUSEMONEY": "IC卡购气金额", "ICTRANSMONEY": "IC卡账户余额转换",
        "ICBANKTRANSMONEY": "IC卡银行账户余额转换", "ICUSECOMPLEMENT": "IC卡补气补量", "ICICR": "IC卡写卡", "ICBANKICR": "IC卡银行写卡",
        "METERCHG": "普表收费", "METERBANKCHG": "普表银行收费", "ICRFDBALANCE": "IC卡退款入账",
        "ICRFD": "IC卡退款", "ICRFDICR": "IC卡退款写卡冲正","CHANGEMBLL":"换表剩余气量转余额","WASTECHG":"垃圾费收费",
        "RFDRESIVE":"退款领取","WASTEBLL":"垃圾费计费","ICBCLEAR":"虚拟余额清零"
    };
    var tradeTyp = { "BLL":"计费", "DIS": "优惠", "CHG": "收费", "COR": "冲正", "CLR": "清算", "RFD": "退款", "ICR": "写卡", "ICB": "扣划" }
    var clrtag = { "0": "未清算", "1": "清算中", "2": "已清算", "9": "不需清算" }
    $(".export-excel").attr("data-table", ".tabPrint");
    //    $(".export-excel").attr("data-filename","");
    $(".export-excel").on("click", function (e) {
        e.preventDefault();
        var exportTable = $(this).data("table");
        var filename = $("#title").html();//$(this).data("filename");
        var ignoreColumn = "";//$(this).data("ignorecolumn");
        $(exportTable).tableExport({
            fileName: filename,
            type: 'excel',
            escape: 'false',
            excelstyles: ['border-bottom', 'border-top', 'border-left', 'border-right'],
            ignoreColumn: '[' + ignoreColumn + ']'
        });
    });

    jQuery(document).ready(function () {
        ComponentsPickers.init();
    });

    var getPriceBalance = function () {
        return {
            f: function (data, row) {
                return (row.price*row.ysl).toFixed(2);
            }
        }
    }();
    var getBasePriceBalance = function () {
        return {
            f: function (data, row) {
                return (row.basePrice*row.ysl).toFixed(2);
            }
        }
    }();
    var getTradeType = function () {
        return {
            f: function (data, row) {
                return tradeTyp[row.tradeType];                
            }
        }
    }();
    var getTradeTypeDesc = function () {
        return {
            f: function (data, row) {
                return tradeTypeDesc[row.tradeTypeDesc];                
            }
        }
    }();
    var getDiffBalance = function () {
        return {
            f: function (data, row) {
                return ((row.basePrice-row.price)*row.ysl).toFixed(2);
            }
        }
    }();
    $(function () {

        var areas = new Array();
        var area_id = JSON.parse(localStorage.getItem("user_info")).area_id;
        areas.push(area_id);
        //查询areaId下级areaId
        var queryCondion = RQLBuilder.and([
            RQLBuilder.equal("status", "1"),
            RQLBuilder.equal("parentAreaId", area_id)
        ]).rql()
        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            type: 'get',
            async: false,
            url: hzq_rest + "gasbizarea?query=" + queryCondion,
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    areas.push(data[i].areaId);
                }
            }
        });
        var AreaHelper1 = RefHelper.create({
            ref_url: 'gasbizarea?query={"areaId":{"$in":' + JSON.stringify(areas) + '}}',
            ref_col: "areaId",
            ref_display: "areaName",
            "sort": "posCode"
        });
        gs = AreaHelper1.getRawData();
        gs.forEach(function (val) {
            $('#find_area_id').append('<option value="' + val.areaId + '">' + val.areaName + '</option>');
        })
        //加载用气性质
        $.ajax({
            url: "hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd",
            type: "POST",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify({
                cols: "gasTypeId,gasTypeName",
                froms: "gasBizGasType",
                wheres: " posCode = 0 and length(gasTypeCode)=3 order by gasTypeCode",
                page: "false"
            }),
            dataType: "json",
            success: function (data) {
                if (data.rows) {
                    data.rows.forEach(function (m) {
                        $('#find_gas_type_id').append('<option value="' + m.gasTypeId + '">' + m.gasTypeName + '</option>');
                    })
                    gasTypeName = data.rows;
                }
            }
        });

        //查询按钮时间 新增用户是大于去年12月26日
        $("#find_sign").click(function () {
            var areaid="1";//哈中庆区域ID
            if ($("#find_date").val() == "") {
                bootbox.alert("请您选择要查询的月份！");
                return;
            }

            var userInfo = JSON.parse(localStorage.getItem("user_info"));

            var where="";
            if(area_id!=1){
                where+=(" and areaId="+area_id);
            }
            var find_area_id = $("#find_area_id").val(),
                find_customer_name = $("#find_customer_name").val(),
                find_customer_code = $("#find_customer_code").val(),
                find_start_trade_date = $("#find_start_trade_date").val(),
                find_end_trade_date = $("#find_end_trade_date").val(),
                find_start_unbolt_time=$("#find_start_unbolt_time").val(),
                find_end_unbolt_time=$("#find_end_unbolt_time").val(),
                find_rating_flux_min=$("#find_rating_flux_min").val(),
                find_rating_flux_max=$("#find_rating_flux_max").val(),
                find_trade_type=$("#find_trade_type").val(),
                
                find_gas_type_id = $("#find_gas_type_id").val();
                
            if (find_gas_type_id != "") {
                where += " and gasTypeId like '" + find_gas_type_id + "%'"
            }

            if(area_id=="1"){
                if (find_area_id != "" && find_area_id != "1") {
                    where += " and areaId=" + find_area_id;
                }
            }else{
                where += " and areaId=" + area_id;
            }
            if(find_start_trade_date){
                where+= " and tradeDate>=to_date('"+find_start_trade_date+"','yyyy-MM-dd')";
            }
            if(find_end_trade_date){
                find_end_trade_date=moment(find_end_trade_date).add('day',1).format('YYYY-MM-DD');
                where+= " and tradeDate<to_date('"+find_end_trade_date+"','yyyy-MM-dd')";
            }
            if (find_customer_name != "") {
                where += " and customerName like '%" + find_customer_name + "%'";
            }
            if (find_customer_code != "") {
                where += " and customerCode like '%" + find_customer_code + "%'";
            }
            if (find_start_unbolt_time != "") {
                where += " and unboltTime>=to_date('"+find_start_unbolt_time+"','yyyy-MM-dd HH24:mi:ss')";
            }
            if (find_end_unbolt_time != "") {
                find_end_unbolt_time=moment(find_end_unbolt_time).add('day',1).format('YYYY-MM-DD');
                where += " and unboltTime<to_date('"+find_end_unbolt_time+"','yyyy-MM-dd')";
            }
            if(find_rating_flux_min){
                where += " and ratingFlux>='"+find_rating_flux_min+"'";
            }

            if(find_rating_flux_max){
                where += " and ratingFlux>='"+find_rating_flux_max+"'";
            }
            if(find_rating_flux_min){
                where += " and ratingFlux<='"+find_rating_flux_min+"'";
            }
            if(find_trade_type){
                where += " and tradeType='"+find_trade_type+"'";
            }
            if(!where){
                //alert("请选择查询条件");
                //return;
            }

            $('#divtable').html('');
            var bd =
                { 
                    cols: "sys_guid() guid,customerCode,customerName,areaName,areaId,price,basePrice,gas ysl,sse yse,\
                        unboltTime,gasTypeName,customerTypeName,ratingFlux,0 priceBalance,0 basePriceBalance,\
                        0 diffBalance,to_char(tradeDate,'yyyy-MM-dd HH24:mm:ss') tradeDate,tradeType,tradeTypeDesc,to_char(copyTime,'yyyy-MM-dd HH24:mm:ss') copyTime",
                    froms: "vmReportMeigaiqiDetail",
                    wheres: " tradeType<>'CLR' "+where + " order by ysl desc",
                    page:true,
                };
            xw = XWATable.init({
                divname: "divtable",
                //----------------table的选项-------
                pageSize: 10, 			//Initial pagesize
                columnPicker: true,         //Show the columnPicker button
                sorting: true,
                transition: 'fade',  //(bounce, fade, flip, rotate, scroll, slide).
                checkboxes: false,           //Make rows checkable. (Note. You need a column with the 'unique' property)
                checkAllToggle: true,        //Show the check-all toggle//+RQLBuilder.like("KEYY", "a").rql()
                restURL: 'hzqs/dbc/pbsel.do?fh=SELDBC0000000J00&resp=bd&bd=' + encodeURIComponent(JSON.stringify(bd)),
                key_column: 'guid',
                coldefs: [
                    {
                        col: "guid",
                        hidden: true,
                        unique: true
                    },
                    {
                        col: "customerCode",
                        friendly: "客户号",
                        sorting: true,
                        index: 1
                    },
                    {
                        col: "customerName",
                        friendly: "客户名",
                        sorting: true,
                        index: 2
                    },
                    {
                        col: "areaName",
                        friendly: "供气单位",
                        sorting: true,
                        index: 3
                    },
                    {
                        col: "gasTypeName",
                        friendly: "用气性质",
                        sorting: true,
                        index: 4,
                    },
                    {
                        col: "customerTypeName",
                        friendly: "表类型",
                        sorting: false,
                        index: 5
                    },
                    {
                        col: "unboltTime",
                        friendly: "开栓日期",
                        sorting: true,
                        index: 6
                    },
                    {
                        col: "ysl",
                        friendly: "销售量",
                        sorting: true,
                        index: 7
                    },
                    {
                        col: "price",
                        friendly: "优惠价",
                        sorting: true,
                        index: 8
                    },
                    {
                        col: "yse",
                        friendly: "优惠销售额",
                        sorting: true,
                        //format:getPriceBalance,
                        index: 9
                    },
                    {
                        col: "basePrice",
                        friendly: "标准价",
                        sorting: false,
                        index: 10
                    },
                    {
                        col: "basePriceBalance",
                        friendly: "标准价销售额",
                        sorting: true,
                        format:getBasePriceBalance,
                        index: 11
                    },{
                        col: "diffBalance",
                        friendly: "差额气费",
                        sorting: true,
                        format:getDiffBalance,
                        index: 12
                    },
                    {
                        col: "ratingFlux",
                        friendly: "表流量",
                        sorting: false,
                        index: 13
                    },
                    {
                        col: "tradeDate",
                        friendly: "交易时间",
                        sorting: true,
                        index: 14
                    },
                    {
                        col: "tradeType",
                        friendly: "交易类型",
                        format:getTradeType,
                        sorting: false,
                        index: 15
                    },
                    {
                        col: "tradeTypeDesc",
                        friendly: "交易描述",
                        format:getTradeTypeDesc,
                        sorting: false,
                        index: 15
                    },
                    {
                        col: "copyTime",
                        friendly: "抄表时间",
                        sorting: false,
                        index: 15
                    },
                ],
            });
        });
    });

</script>
<!-- End of User Script-->

</html>